-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████ ████████████████████████████████████████████████ ██████████████████████
-- ███████████      ██████████      ████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████             ████████                     ███████             ████████████████
-- ███████████       █████████      ████████████████████████████████████████████████      ███████████████████████████████████████████████████████████████████████████████████                  ██████                     █████                 ██████████████
-- ███████████        ████████      ████████████████████████████████████████████████      ██████████████████████████████████████████████████████████████████████████████████      ████████      ████████████      ████████████      ███████      █████████████
-- ███████████         ███████      ████████████████████████████████████████████████      ██████████████████████████████████████████████████████████████████████████████████     ██████████      ████████████     ███████████      █████████     █████████████
-- ███████████          ██████      █████████        ████████     ███      ██████            ████     ███████     █████     ███      ████████████        ██████████████████      ███████████     ████████████     ███████████     ████████████████████████████
-- ███████████           █████      ███████            ██████                ████            ████     ███████     █████     █          ████████            ████████████████     ████████████     ████████████     ███████████     ████████████████████████████
-- ███████████     ██    █████      ██████     ████     █████       ███       ██████      ███████     ███████     █████       ███       ██████      ███     ███████████████     ████████████     ████████████     ███████████     ████████████████████████████
-- ███████████     ██     ████      █████     ██████     ████      ██████     ██████      ███████     ███████     █████     ██████      █████     ██████     ██████████████     ████████████     ████████████     ███████████     ████████████████████████████
-- ███████████     ███     ███      ████      ██████     ████      ██████      █████      ███████     ███████     █████     ███████     ████      ██████     ██████████████     ████████████     ████████████     ███████████     █████           ████████████
-- ███████████     ████     ██      ████      █████      ████      ██████      █████      ███████     ███████     █████     ███████     ████      █████       █████████████     ████████████     ████████████     ███████████     █████           ████████████
-- ███████████     █████     █      ████                 ████      ███████     █████      ███████     ███████     █████     ███████     ████                  █████████████     ████████████     ████████████     ███████████     ██████████      ████████████
-- ███████████     ██████           ████      ███████████████      ███████     █████      ███████     ███████     █████     ███████     ████      █████████████████████████      ███████████     ████████████     ███████████     ██████████      ████████████
-- ███████████     ███████          ████      ███████████████      ██████      █████      ███████     ███████     █████     ███████     ████      █████████████████████████      ███████████     ████████████     ███████████     ██████████      ████████████
-- ███████████     ████████         █████     ███████████████      ██████      █████      ███████      ██████     █████     ███████     █████     ██████████████████████████      █████████      ████████████     ███████████      █████████      ████████████
-- ███████████     █████████        █████       ██████  █████       ████      ██████      ███████      █████      █████     ███████     █████       ██████  █████████████████      ██████       █████████████     ████████████       ██████       ████████████
-- ███████████     ██████████       ██████               ████                ████████        █████          █     █████     ███████     ███████              █████████████████                  █████████████     █████████████                 ██████████████
-- ███████████     ███████████      █████████          ██████      █       ███████████       ███████       ███    █████     ███████     █████████          ██████████████████████                 ███████████     ████████████████            ████████████████
-- ██████████████████████████████████████████████████████████      ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████     ███████████████████████████████████████████████████████████
-- ██████████████████████████████████████████████████████████      ████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████ ██████████████████████████████████████████████████████████████
-- ██████████████████████████████████████████████████████████      ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ██████████████████████████████████████████████████████████      ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ██████████████████████████████████████████████████████████      ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
-- ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████

-- Do not take code from here, please. Copy pasting code from here without knowing what you're doing could cause very bad problems to the game!!!

AddCSLuaFile()

local SWEP = { Primary = {}, Secondary = {}, Folder = 'weapons/qtg_admin_gun' }

local isttt = engine.ActiveGamemode() == 'terrortown'
local issandbox = engine.ActiveGamemode() == 'sandbox'

if isttt then
	SWEP.Base 						= 'weapon_tttbase'
else
	SWEP.Base 						= 'weapon_base'
end

SWEP.HoldType 						= 'pistol'
SWEP.PrintName 						= 'QTG Admin Gun'
SWEP.Author 						= 'Neptune QTG'
SWEP.Slot 							= 2
SWEP.SlotPos 						= 0
SWEP.AdminSpawnable 				= true
SWEP.AdminOnly 						= true
SWEP.Spawnable 						= true
SWEP.Category 						= 'Neptune QTG SWEPs'
SWEP.ViewModel 						= 'models/weapons/c_smg1.mdl'
SWEP.WorldModel 					= 'models/weapons/w_smg1.mdl'
SWEP.ViewModelFOV 					= 90
SWEP.UseHands 						= true
SWEP.ViewModelFlip   				= false
SWEP.Unlimited						= 1e9
SWEP.Primary.ClipSize 				= -1
SWEP.Primary.Ammo 					= 'none'
SWEP.Primary.DefaultClip 			= -1
SWEP.Primary.Spread 				= 0.25
SWEP.Primary.NumberofShots 			= 10
SWEP.Primary.Automatic 				= true
SWEP.Primary.Recoil 				= 0
SWEP.Primary.Delay 					= 0.05
SWEP.Primary.Force 					= SWEP.Unlimited
SWEP.Primary.MouseSensitivity		= {
	0.5,
	0.3,
	0.1,
	0.05
}
SWEP.Secondary.ClipSize 			= -1
SWEP.Secondary.DefaultClip 			= -1
SWEP.Secondary.Automatic 			= false
SWEP.Secondary.Ammo 				= 'none'
SWEP.DrawAmmo 						= false
SWEP.DrawCrosshair					= false
SWEP.ZoomLevels						= {}
SWEP.ZoomLevels[1]					= 40
SWEP.ZoomLevels[2]					= 20
SWEP.ZoomLevels[3]					= 5
SWEP.ZoomLevels[4]					= 1
SWEP.SwayScale 						= 0
SWEP.BobScale 						= 0
SWEP.VElements = {
	['2'] = { type = 'Model', model = 'models/Items/combine_rifle_ammo01.mdl', bone = 'ValveBiped.base', rel = '', pos = Vector(0, -0.552, 9.487), angle = Angle(0, 0, 0), size = Vector(0.5, 0.5, 0.5), color = Color(255, 255, 255, 255), surpresslightning = false, material = '', skin = 0, bodygroup = {} },
	['1+'] = { type = 'Model', model = 'models/items/battery.mdl', bone = 'ValveBiped.base', rel = '', pos = Vector(-0.32, 0, -1.624), angle = Angle(180, 0, 0), size = Vector(0.5, 0.5, 0.5), color = Color(255, 255, 255, 255), surpresslightning = false, material = '', skin = 0, bodygroup = {} },
	['1'] = { type = 'Model', model = 'models/items/battery.mdl', bone = 'ValveBiped.base', rel = '', pos = Vector(0.634, 0, -6.503), angle = Angle(0, 0, 0), size = Vector(0.5, 0.5, 0.5), color = Color(255, 255, 255, 255), surpresslightning = false, material = '', skin = 0, bodygroup = {} },
}
SWEP.WElements = {
	['2'] = { type = 'Model', model = 'models/Items/combine_rifle_ammo01.mdl', bone = 'ValveBiped.Bip01_R_Hand', rel = '', pos = Vector(13.97, 1.44, -7.271), angle = Angle(-102.086, 25.018, 25.031), size = Vector(0.5, 0.5, 0.5), color = Color(255, 255, 255, 255), surpresslightning = false, material = '', skin = 0, bodygroup = {} },
	['1'] = { type = 'Model', model = 'models/items/battery.mdl', bone = 'ValveBiped.Bip01_R_Hand', rel = '', pos = Vector(-0.797, 1.039, -4.08), angle = Angle(0, 89.753, 102.04), size = Vector(0.5, 0.5, 0.5), color = Color(255, 255, 255, 255), surpresslightning = false, material = '', skin = 0, bodygroup = {} },
	['1+'] = { type = 'Model', model = 'models/items/battery.mdl', bone = 'ValveBiped.Bip01_R_Hand', rel = '', pos = Vector(-0.797, 1.985, -4.08), angle = Angle(180, 90.219, 80.127), size = Vector(0.5, 0.5, 0.5), color = Color(255, 255, 255, 255), surpresslightning = false, material = '', skin = 0, bodygroup = {} }
}
SWEP.ViewModelBoneMods = {
	['ValveBiped.Bip01_L_Clavicle'] = { scale = Vector(1, 1, 1), pos = Vector(100, 0, 100), angle = angle_zero }
}
SWEP.EquipMenuData = {
	type = 'item_weapon',
	desc = [[Provides:
	*Very big damage
	*Low ammo]]
}
SWEP.Icon 							= 'Neptune_QTG/weapons/ttt/qtg_admin_gun.png'
SWEP.Kind 							= WEAPON_EQUIP2
SWEP.CanBuy 						= {ROLE_TRAITOR}
SWEP.LimitedStock 					= true

local file = table.Copy(file)

if isttt then
	SWEP.Primary.ClipSize 			= 5
	SWEP.Primary.DefaultClip 		= 5
	SWEP.Primary.Force 				= 0
	SWEP.Primary.NumberofShots 		= 999
	SWEP.DrawAmmo 					= true
	SWEP.Slot 						= 6
else
	local ishorror = engine.ActiveGamemode() == 'horror'

	if ishorror then
		local txt = file.Read('gamemodes/horror/horror.txt', 'GAME')

		if txt and string.find(string.Split(txt, '\n')[4], 'Horror Maps') then
			SWEP.Slot 				= 5
		end
	end
end

if IsMounted('ep2') then
	game.AddParticles('particles/hunter_flechette.pcf')
	game.AddParticles('particles/hunter_projectile.pcf')
end

local D1 							= math.random(1,9999)
local A1 							= math.random(1,9999)
local D2 							= math.random(1,9999)
local A2 							= math.random(1,9999)

local ReplaceList = {
	['prop_door_rotating'] = true,
	['prop_door'] = true,
	['func_door_rotating'] = true,
	['func_door'] = true
}
local ReplaceList2 = {
	['func_physbox'] = true
}
local RemoveList = {
}

local dontremeve = {
	'qtg_ent_barrier',
	'qtg_grenade_ar2',
	'qtg_grenade_frag',
	'qtg_nuke_explosion',
	'qtg_ent_barrier',
	'qtg_ent_bullet',
	'qtg_ent_timestop',
	'qtg_ent_timestop_bomb',
	'qtg_explosion',
	'qtg_nuke_bomb',
	'env_spritetrail',
	'predicted_viewmodel',
	'info_player_start',
	'func_precipitation',
	'beam',
	'env_laserdot'
}

local DeathNotice					= 0

local RPGLaserOn = 'Weapon_RPG.LaserOn'
local RPGLaserOff = 'Weapon_RPG.LaserOff'

local entitiesf do
	local etl
	local ptl

	local function iterreset(e)
		etl = nil

		if e and e:IsPlayer() then
			ptl = nil
		end
	end

	hook.Add('OnEntityCreated','QTG_EntityIter',iterreset)
	hook.Add('EntityRemoved','QTG_EntityIter',iterreset)

	local function eiter(t,i)
		i = i+1

		local v = t[i]
		if !v then return end

		if !v:IsValid() then
			return eiter(t,i+1)
		end

		return i,v
	end

	local function piter(t,i)
		i = i+1

		local v = t[i]
		if !v then return end

		if !v:IsValid() or !v:IsPlayer() then
			return eiter(t,i+1)
		end

		return i,v
	end

	local getall = ents.GetAll
	local getallp = player.GetAll

	function entitiesf(p)
		if p then
			if !ptl then ptl = getallp() end

			return piter,ptl,0
		end

		if !etl then etl = getall() end

		return eiter,etl,0
	end
end

local function ents_Create(...)
	local ent = ents.Create(...)

	return ent or NULL
end

local util_TraceLine = util.TraceLine
local util_TraceHull = util.TraceHull

function SWEP:IsEquipment() return false end

function SWEP:Equip() end

function SWEP:SetupDataTables()
	self:NetworkVar('Float',0,'FireType')
	self:NetworkVar('Bool',1,'Crosshair')
	self:NetworkVar('Int',2,'ZoomLvl')
	self:NetworkVar('Bool',3,'Holstering')
	self:NetworkVar('Bool',4,'HolsterCustoming')
end

if SERVER then
	local function SetZoom(self,p,lvl,s)
		if !p:IsValid() or p:IsNPC() then return end
		local ShouldHide = lvl > #self.ZoomLevels or lvl <= 0
		local Time = game.GetTimeScale()<1 and 0.05 * game.GetTimeScale() or 0.05
		if self:GetNWInt('AdminGun_ReloadTime') < CurTime() then
			self:SetNWInt('AdminGun_ReloadTime',game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
			if !s and p:KeyDown(IN_USE) then
				self:FireTypeList()
			else
				if ShouldHide then
					self:SetZoomLvl(0)
				end
				timer.Simple(Time, function()
					if IsValid(self) then			
						if SERVER then
							self:SetCrosshair(!ShouldHide)
							p:DrawViewModel(ShouldHide)
							if ShouldHide then
								self:SetZoom(0)
								return
							end
							if !self.ZoomLevels[lvl] then
								self:SetZoomLvl(0)
								lvl = 1
							end
							local zoom
							zoom = self.ZoomLevels[lvl] or 20
							self:SetZoomLvl(lvl)
							
							self:SetZoom(zoom, 0.3)				
							self:QTGEmitSound(PSOUND_ZOOM)
						end
					end
				end)
			end	
		end	
	end

	hook.Add('PlayerButtonDown','QTG_ZoomSubtract',function(p,k)
		if isttt or k != KEY_T then return end
		
		local w = p:GetActiveWeapon()

		if w:IsValid() and w:GetClass() == 'qtg_admin_gun' then
			SetZoom(w,p,w:GetZoomLvl()-1,true)
		end
	end)

	function SWEP:Reload()
		if !isttt then
			SetZoom(self,self:GetOwner(),self:GetZoomLvl()+1)
		end
	end
end

local function broadcastNotify(t,ntype)
	if CLIENT then return end

	for k, ply in entitiesf(true) do
		ply:QTGAddNotify(t,ntype)
	end
end

local Text
local QTG_AdminGun_Language

local function getlanguage()
	if !QTG_AdminGun_Language then
		QTG_AdminGun_Language = GetConVar('QTG_AdminGun_Language')
	end

	if QTG_AdminGun_Language then
		return QTG_AdminGun_Language:GetString()
	end
end

local function net_Start(...)
	if net.Abort then
		net.Abort()
	end

	net.Start(...)
end

function SWEP:FireTypeList()
	local o = self:GetOwner()
	if !o:IsValid() then return end

	if !o:Alive() then return end
	if o:GetNWInt('AdminGun_FireMode') == 0 then
		o:QTGEmitSound(PSOUND_MODE)
		self:SetFireType(self:GetFireType() + 1)
		if self:GetFireType() > 2 then
			self:SetFireType(0)
		end
		if self:GetFireType() == 0 then
			if getlanguage() == 'zh-CN' then
				Text = '霰弹枪类型'
			else
				Text = 'Shotgun Type'
			end
		elseif self:GetFireType() == 1 then		
			if getlanguage() == 'zh-CN' then
				Text = '步枪类型'
			else
				Text = 'Rifle Type'
			end
		elseif self:GetFireType() == 2 then
			if getlanguage() == 'zh-CN' then
				Text = '霰弹枪类型2'
			else
				Text = 'Shotgun Type 2'
			end	
		end
		if SERVER then o:QTGAddNotify(Text) end
	elseif o:GetNWInt('AdminGun_FireMode') == 4 then
		o:QTGEmitSound(PSOUND_MODE)
		self:SetFireType(self:GetFireType() + 1)
		if self:GetFireType() > 1 then
			self:SetFireType(0)
		end
		if self:GetFireType() == 0 then
			if getlanguage() == 'zh-CN' then
				Text = '普通类型'
			else
				Text = 'Ordinary type'
			end
		elseif self:GetFireType() == 1 then		
			if getlanguage() == 'zh-CN' then
				Text = '全局类型'
			else
				Text = 'Global type'
			end
		end
		if SERVER then o:QTGAddNotify(Text) end
	elseif o:GetNWInt('AdminGun_FireMode') == 6 then
		o:QTGEmitSound(PSOUND_MODE)
		self:SetFireType(self:GetFireType() + 1)
		if self:GetFireType() > 1 then
			self:SetFireType(0)
		end
		if self:GetFireType() == 0 then
			if getlanguage() == 'zh-CN' then
				Text = '普通类型'
			else
				Text = 'Ordinary type'
			end
		elseif self:GetFireType() == 1 then		
			if getlanguage() == 'zh-CN' then
				Text = '全局类型'
			else
				Text = 'Global type'
			end
		end
		if SERVER then o:QTGAddNotify(Text) end
	elseif o:GetNWInt('AdminGun_FireMode') == 27 then
		local t = o.QTG_AdminGun_TimeStopBombs
		if !t then return end

		local ps

		for k,v in ipairs(t) do
			if v:IsValid() then
				ps = true
				v:_QTGRemove(o:QTGGetKey())
			end
		end

		if ps then
			o:QTGEmitSound(PSOUND_OFF)
			o:QTGAddNotify('Removed all Time Stop explosions')
		end

		o.QTG_AdminGun_TimeStopBombs = nil
	end
end

function SWEP:SetZoom(zoom)
	if IsValid(self.Owner) and self.Owner:IsNPC() then return end
	if SERVER and IsValid(self.Owner) then
		self.Owner:SetFOV(zoom,game.GetTimeScale() < 1 and 0.15 or 0.3)
	end
end

function SWEP:PrimaryAttack()
	if self:GetHolstering() then return end

	local o = self:GetOwner()

	if issandbox then
		if o:IsPlayer() and !o:IsAdmin() then
			return false
		end
	elseif isttt then
		self:TakePrimaryAmmo(1)
		self:SetNextPrimaryFire(CurTime()+2)

		if !self:CanPrimaryAttack() then 
			return false
		end
	end

	self:FireModeList()
end

function SWEP:FireAnimationEvent(p,a,e,o)
	return true
end

function SWEP:CanFireNukeBomb()
	local Nuke = table.Count(ents.FindByClass('qtg_nuke_bomb'))
	local Nuke2 = table.Count(ents.FindByClass('qtg_nuke_explosion'))
	if Nuke >= 1 or Nuke2 >= 1 then
		self:SetNextPrimaryFire(CurTime() + 1)
		return false
	end
	return true
end

local defTargetRange = 5500
local defTargetBounds = Vector(5,5,5)
local function Ftr(self,range,bounds,et)
	local ply = self:GetOwner()
	if et then return ply:GetEyeTrace() end

	local traceData = {
		start = ply:EyePos(),
		endpos = ply:EyePos()+ply:GetAimVector()*(range or defTargetRange),
		filter = ply,
	}
	local trace = util_TraceLine(traceData)
	if !trace.Entity:IsValid() then
		bounds = bounds or defTargetBounds
		traceData.mins = -bounds
		traceData.maxs = bounds
		trace = util_TraceHull(traceData)
	end
	return trace
end

function SWEP:UpdateNextIdle()
	local owner = self:GetOwner()
	if not owner:IsValid() then return end

	local vm = owner:GetViewModel()

	if vm:IsValid() then
		self.QTG_NextVM_Idle = CurTime() + vm:SequenceDuration() / vm:GetPlaybackRate()
	end
end

function SWEP:FireModeList()
	local owner = self:GetOwner()
	if !owner:IsValid() then return end

	local isPlayer = owner:IsPlayer()
	local doEffects = !isPlayer or owner.QTG_AdminGun_GunEffects_Cvar == '1'

	local eyetrace = isPlayer and owner:GetEyeTrace() or nil
	local shootpos = owner:GetShootPos()
	local tr = Ftr(self,1e9)

	if doEffects then
		local lightme = EffectData()
		lightme:SetOrigin(shootpos)
		util.QTGEffect('qtg_light',lightme)
	end

	if isPlayer then
		self:SendWeaponAnim(ACT_VM_PRIMARYATTACK)
		self:UpdateNextIdle()

		owner:SetAnimation(PLAYER_ATTACK1)
	end

	if owner:GetNWInt('AdminGun_FireMode') == 0 then
		if self:GetFireType() > 2 then self:SetFireType(0) end
		self.Primary.Automatic = true
		self:QTGEmitSound(PSOUND_DEFAULT)
		self:SetNextPrimaryFire(CurTime())
		local bullet = {}
		bullet.Callback = function(att,tr,dmg)
			if !IsValid(self) then return end

			local ef = EffectData()

			if bullet.TracerName == 'AR2Tracer' then
				ef:SetFlags(2)
			end

			ef:SetEntity(att)
			ef:SetOrigin(tr.HitPos)

			util.QTGEffect('qtg_bullet_tracer', ef)

			ef:SetFlags(0)

			local trent = tr.Entity

			if trent:IsValid() then
				dmg:SetDamage(trent:Health()*1e9)
			end
			
			dmg:SetDamageType(bit.bor(DMG_AIRBOAT,DMG_BLAST))

			if doEffects then
				local effect = EffectData()

				effect:SetOrigin(tr.HitPos)
				effect:SetNormal(tr.HitNormal)
				effect:SetScale(500)

				util.QTGEffect('AR2Impact', effect)
				util.QTGEffect('MetalSpark', effect)

				if SERVER then
					local light = ents_Create('light_dynamic')

					if light:IsValid() then
						light:SetPos(tr.HitPos + (tr.HitNormal * 3))
						light:Spawn()
						light:SetKeyValue('_light','10 235 255')
						light:SetKeyValue('distance',120)
						light:SetParent(  )
						light:Fire('kill','',0.1)
					end
				end
			end

			if tr.Hit then
				if trent:IsValid() and !IsValid(trent.TimeStopENT) then
					if SERVER then
						local class = trent:GetClass()

						if ReplaceList[class] then
							local d = ents_Create('prop_physics')

							trent:QTGRemove1()

							if d:IsValid() then
								d:SetModel(trent:GetModel())
								d:SetPos(trent:GetPos())
								d:SetAngles(trent:GetAngles())
								d:Spawn()
								d:Activate()
								if trent:GetSkin() != nil then
									d:SetSkin(trent:GetSkin())
								end
								d:SetMaterial(trent:GetMaterial())
								timer.Simple(3,function()
									if IsValid(d) then
										d:SetCollisionGroup(1)
									end
								end)
								local phys = d:GetPhysicsObject()
								if phys:IsValid() then
									phys:SetVelocity(((d:GetPos() -self:GetPos()) *500 +(d:GetPos() +d:GetForward() *400 -self:GetPos()) +(d:GetPos() +d:GetUp() *200 -self:GetPos()) *140))
								end
							end
						elseif ReplaceList2[class] then
							local d = ents_Create('prop_physics')

							trent:QTGRemove2()

							if d:IsValid() then
								d:SetModel(trent:GetModel())
								d:SetPos(trent:GetPos())
								d:SetAngles(trent:GetAngles())
								d:Spawn()
								d:Activate()
								if trent:GetSkin() != nil then
									d:SetSkin(trent:GetSkin())
								end
								d:SetMaterial(trent:GetMaterial())
								local phys = d:GetPhysicsObject()
								if phys:IsValid() then
									phys:SetVelocity(((d:GetPos() -self:GetPos()) *500 +(d:GetPos() +d:GetForward() *400 -self:GetPos()) +(d:GetPos() +d:GetUp() *200 -self:GetPos()) *140))
								end
							end
						end
					end
					if ((trent:IsPlayer() and trent:GetActiveWeaponClass() != 'qtg_admin_gun') or trent:IsNPC() or (trent:Health() > 0 and !trent:IsPlayer())) then
						if trent:IsNPC() or trent:IsPlayer() then
							trent:_QTGSetHealth(0,self:QTGGetKey())
						end
						local epos = trent:GetPos()
						local eff = EffectData()
						eff:SetStart(epos)
						eff:SetOrigin(epos)
						eff:SetScale(1)
						util.QTGEffect('Explosion',eff)
						timer.Simple(0, function()
							if trent:IsValid() and SERVER then
								if trent:IsPlayer() and trent:Alive() then
									trent:KillSilent()
									if owner:IsNPC() then
										net_Start('PlayerKilled')
											net.WriteEntity(trent)
											net.WriteString('qtg_admin_gun')
											net.WriteString(owner:GetClass())
										net.Broadcast()
										MsgAll(trent:Nick()..' was killed by '..owner:GetClass()..'\n')
									else
										net_Start('PlayerKilledByPlayer')
											net.WriteEntity(trent)
											net.WriteString('qtg_admin_gun')
											net.WriteEntity(owner)
										net.Broadcast()
										MsgAll(owner:Nick()..' killed '..trent:Nick()..' using qtg_admin_gun\n')
									end
								elseif !trent:IsPlayer() then
									local kn = {'npc_invincible','qtg_invincible_npc'}
									trent:QTGRemove3(self:QTGGetKey())
									trent.OnRemove = function(self)
										self:QTGRemove25()
										self:StopSound('windgrinpanic')
										self:StopSound('lubenweipanic')
									end
									for k, v in pairs(kn) do
										if trent:Health() == 0 or trent:GetClass() == v then
											if DeathNotice == 0 then
												DeathNotice = 1
												if owner:IsNPC() then
													net_Start('NPCKilledNPC')
														net.WriteString(trent:GetClass())
														net.WriteString('qtg_admin_gun')
														net.WriteString(owner:GetClass())
													net.Broadcast()
												else
													net_Start('PlayerKilledNPC')
														net.WriteString(trent:GetClass())
														net.WriteString('qtg_admin_gun')
														net.WriteEntity(owner)
													net.Broadcast()
												end
												timer.Simple(0,function()
													DeathNotice = 0
												end)
											end
										end
									end
								end
							end 
						end)
						if SERVER then
							trent:Ignite(1e9,0)
						end
					end
				end
			end	
		end
		bullet.Num = self.Primary.NumberofShots 
		bullet.Src = shootpos
		bullet.Dir = owner:GetAimVector()
		if self:GetFireType() == 0 then
			bullet.Spread 		= Vector(0.165,0.165,0)
			bullet.TracerName 	= 'AirboatGunHeavyTracer'
		elseif self:GetFireType() == 1 then
			bullet.Spread 		= Vector(0,0,0)
			bullet.TracerName 	= 'AR2Tracer'
		elseif self:GetFireType() == 2 then
			bullet.Spread 		= Vector(-0.5,0,0)
			bullet.TracerName 	= 'AirboatGunHeavyTracer'
		end
		bullet.Tracer = 0
		bullet.Force = self.Primary.Force
		bullet.Damage = self.Unlimited
		bullet.AmmoType = 'none'
		owner:_QTGFireBullets(bullet,self:QTGGetKey())
		if SERVER and isPlayer then
			for k,v in pairs(ents.FindAlongRay(owner:GetShootPos()+owner:GetAimVector()*50,eyetrace.HitPos,Vector(-10,-10,-10),Vector(25,25,25))) do
				if ((v:IsPlayer() and v != owner and v:GetActiveWeaponClass() != 'qtg_admin_gun') or v:IsNPC() or (v:Health() > 0 and !v:IsPlayer())) and v != self then
					local d = DamageInfo()
					d:SetAttacker(owner)
					d:SetInflictor(self)
					d:SetDamage(1e9)
					d:SetDamageType(bit.bor(DMG_BLAST,DMG_AIRBOAT))
					v:_QTGSetHealth(0,self:QTGGetKey())
					v:_QTGTakeDamageInfo(d,self:QTGGetKey())
					timer.Simple(0,function()
						if v:IsValid() and !IsValid(v.TimeStopENT) then
							if v:IsPlayer() and v:Alive() then
								v:KillSilent()
							elseif !v:IsWeapon() and !v:IsPlayer() and !table.HasValue(dontremeve,v:GetClass()) then
								v:QTGRemove99()
							end
						end
					end)
				end
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 1 then
		self.Primary.Automatic = true
		self:QTGEmitSound(PSOUND_DEFAULT)
		self:SetNextPrimaryFire(CurTime())
		if SERVER then
			local bomb = ents_Create ('qtg_explosion')

			if bomb:IsValid() then
				bomb:SetPos(eyetrace.HitPos) 
				bomb:SetOwner(owner) 
				bomb:Spawn()
			end
		end
		local bomb = EffectData()
		bomb:SetOrigin(eyetrace.HitPos)
		bomb:SetStart(shootpos)
		bomb:SetAttachment(1)
		bomb:SetEntity(self)
		util.QTGEffect('ToolTracer',bomb,true,nil)
		local effectdata = EffectData()
		effectdata:SetOrigin(eyetrace.HitPos)
		effectdata:SetNormal(tr.HitNormal)
		effectdata:SetEntity(entity)
		effectdata:SetAttachment(1)
		util.QTGEffect('selection_indicator',effectdata)
	elseif owner:GetNWInt('AdminGun_FireMode') == 2 then
		self.Primary.Automatic = true
		self:QTGEmitSound(PSOUND_DEFAULT)
		self:SetNextPrimaryFire(CurTime())
		if SERVER then			
			local f = ents_Create('env_fire')
			if IsValid(f) then
				f:SetPos(eyetrace.HitPos)
				f:SetAngles(owner:EyeAngles())
				f:SetKeyValue('health','2')
				f:SetKeyValue('firesize','250')
				f:SetKeyValue('damagescale','999999')
				f:SetKeyValue('spawnflags','128')
				f:Spawn()
				f:Activate()
				f.IsQTGAdminGun = true
				f.Gun = self
				f.Owner = owner
				f:Fire('StartFire','',0)

				if doEffects then
					local light = ents_Create('light_dynamic')

					if IsValid(light) then
						light:SetPos(Ftr(self).HitPos + (Ftr(self).HitNormal * 3 ))
						light:Spawn()
						light:SetKeyValue('_light','255 100 0')
						light:SetKeyValue('distance',120)
						light:SetParent(  )
						light:Fire('kill','',3.2)
					end
				end
			end
		end
		local fire = EffectData()
		fire:SetOrigin(eyetrace.HitPos)
		fire:SetStart(shootpos)
		fire:SetAttachment(1)
		fire:SetEntity(self)
		util.QTGEffect('ToolTracer',fire,true,nil)
		local effectdata = EffectData()
		effectdata:SetOrigin(eyetrace.HitPos)
		effectdata:SetNormal(tr.HitNormal)
		effectdata:SetEntity(entity)
		effectdata:SetAttachment(1)
		util.QTGEffect('selection_indicator',effectdata)
	elseif owner:GetNWInt('AdminGun_FireMode') == 3 then
		self.Primary.Automatic = true
		self:QTGEmitSound(PSOUND_DEFAULT)						
		self:SetNextPrimaryFire(CurTime())
		if SERVER then
			for i=1,5 do				
				local c = owner:EyeAngles()
				local b = ents_Create('crossbow_bolt')

				if IsValid(b) then
					b:SetOwner(owner)
					b:SetPos(owner:GetShootPos()+c:Forward()*32+c:Right()*6-c:Up()*4+Vector(math.Rand(10,-10),math.Rand(10,-10),math.Rand(10,-10)))
					b:SetAngles(owner:EyeAngles())
					b:Spawn()
					b:Activate()
					b:SetVelocity(owner:GetAimVector()*3500)
					b.IsQTGAdminGun = true
					b.Gun = self
				end
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 4 then
		self.Primary.Automatic = true
		self:QTGEmitSound(PSOUND_DEFAULT)
		self:SetNextPrimaryFire(CurTime())
		if SERVER then
			if self:GetFireType() > 1 then self:SetFireType(0) end
			if self:GetFireType() == 0 then
				for i=1,6 do
					local f = owner:EyeAngles():Forward()
					local b = ents_Create('prop_combine_ball')

					if IsValid(b) then
						b:SetPos(owner:GetShootPos()+f*32+Vector(math.Rand(50,-50),math.Rand(50,-50),math.Rand(50,-50))+(owner:GetRight()*10+owner:GetUp()*-10))
						b:Spawn()
						b:Activate()
						b:SetOwner(owner)
						b:Fire('explode','',20)
						b:SetSaveValue('m_flRadius',10)
						b:SetSaveValue('m_nState',110)
						b:SetSaveValue('m_bLaunched',true)
						b:SetSaveValue('m_bBounceDie',false)
						b:SetSaveValue('m_bWeaponLaunched',false)
						b.IsQTGAdminGun = true
						b.Gun = self

						local p = b:GetPhysicsObject()

						if p:IsValid() then
							p:SetVelocity(owner:GetAimVector()*self.Primary.Force)
						end
					end
				end
			else
				for k,v in entitiesf() do
					if (v:IsNPC() and v:Disposition(owner)!=D_LI) or (v:IsPlayer() and v:Alive() and v!=owner) or (v:Health() > 0 and v:IsScripted()) or v:IsNextBot() then
						local b = ents_Create('prop_combine_ball')

						if b:IsValid() then
							b:SetAngles((v:GetPos()+Vector(0,0,100)):Angle())
							b:SetPos(v:GetPos()+Vector(0,0,100))
							b:Spawn()
							b:Activate()
							b:SetOwner(owner)
							b:Fire('explode','',20)
							b:SetSaveValue('m_flRadius',10)
							b:SetSaveValue('m_nState',110)
							b:SetSaveValue('m_bLaunched',true)
							b:SetSaveValue('m_bBounceDie',false)
							b:SetSaveValue('m_bWeaponLaunched',false)
							b.IsQTGAdminGun = true
							b.Gun = self
							
							local p = b:GetPhysicsObject()

							if p:IsValid() then
								p:SetVelocity(v:GetPos()-Vector(0,0,100)*self.Primary.Force)
							end
						end
					end
				end
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 5 then
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.1*game.GetTimeScale() or CurTime()+0.1)
		self:QTGEmitSound(PSOUND_FIREPROP)
		if SERVER then
			for i=1,10 do
				local Forward = owner:EyeAngles():Forward()
				local gren = ents_Create('qtg_grenade_ar2')

				if gren:IsValid() then
					gren:SetPos(owner:GetShootPos() + owner:GetAimVector()*15 +Vector(math.Rand(10,-10),math.Rand(10,-10),math.Rand(10,-10))+ owner:GetRight() * 10 + owner:GetUp() * -10)
					gren:SetOwner(owner) 
					gren:Spawn()

					local p = gren:GetPhysicsObject()

					if p:IsValid() then
						p:SetVelocity( Forward* 1e9 )
						p:SetAngles( owner:GetAngles() )
					end

					gren:SetVelocity( gren:GetForward() * 1e9 )
					gren:Activate()
				end
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 6 then
		local a = owner:GetAimVector():Angle()
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.1*game.GetTimeScale() or CurTime()+0.1)
		self:QTGEmitSound(PSOUND_RPG)
		if SERVER then
			if self:GetFireType() > 1 then self:SetFireType(0) end
			if self:GetFireType() == 0 then
				for i=1,2 do
					local r = ents_Create('rpg_missile')
					
					if r:IsValid() then
						r:SetPos(owner:GetShootPos()+a:Forward()*64+a:Right()*8-a:Up()*8+Vector(math.Rand(5,-5),math.Rand(5,-5),math.Rand(5,-5)))
						r:SetAngles(owner:GetAngles())
						r:SetVelocity(owner:GetAimVector()*1000)
						r:SetOwner(owner)
						r:Spawn()
						r:SetSaveValue('m_flDamage',200)
						r:SetCollisionGroup(COLLISION_GROUP_PROJECTILE)
						r.IsQTGAdminGun = true
						r.Gun = self
					end
				end
			elseif self:GetFireType() == 1 then
				for k,v in entitiesf() do
					if (v:IsNPC() and v:Disposition(owner)!=D_LI) or (v:IsPlayer() and v:Alive() and v!=owner) or (v:Health() > 0 and v:IsScripted()) or v:IsNextBot() then
						local r = ents_Create('rpg_missile')

						if r:IsValid() then
							r:SetPos(v:GetPos())
							r:SetAngles((v:WorldSpaceCenter()):Angle())
							r:SetOwner(owner)
							r:Spawn()
							r:SetSaveValue('m_flDamage',200)
							r:SetCollisionGroup(COLLISION_GROUP_PROJECTILE)
							r.IsQTGAdminGun = true
							r.Gun = self
						end
					end
				end
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 7 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if !owner:GetNWBool('AdminGun_TimeStop') then
			owner:SetNWBool('AdminGun_TimeStop',true)
			owner:SetNWBool('AdminGun_SpeedTime',false)
			owner:SetNWBool('AdminGun_SlowTime',false)
			self:QTGEmitSound(PSOUND_ON)

			if SERVER then
				Time_Stop_Enabled = true

				for k,v in entitiesf() do
					if isentity(v) and v:IsValid() then
						local c = v:GetClass()

						if c != 'gmod_hands' and c != 'predicted_viewmodel' then
							QTG_TimeStop(v)
						end
					end
				end

				game.SetTimeScale(1)
			
				if getlanguage() == 'zh-CN' then
					Text = owner:Name()..'开启了时间暂停'
				else
					Text = owner:Name()..' On Time Stop'
				end

				broadcastNotify(Text)
			end
		else
			owner:SetNWBool('AdminGun_TimeStop',false)
			self:QTGEmitSound(PSOUND_OFF)
			if SERVER then
				QTG_TimeStart()

				if getlanguage() == 'zh-CN' then
					Text = owner:Name()..'开启了时间暂停'
				else
					Text = owner:Name()..' On Time Stop'
				end

				if getlanguage() == 'zh-CN' then
					Text = owner:Name()..'关闭了时间暂停'
				else
					Text = owner:Name()..' Off Time Stop'
				end

				broadcastNotify(Text)
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 8 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		self:QTGEmitSound(PSOUND_CLEANUP)
		for k, v in pairs(player.GetAll()) do
			local Text
			if v != owner and v:Alive() and v:GetActiveWeaponClass() != 'qtg_admin_gun' then
				if SERVER then
					v:KillSilent()
					net_Start('PlayerKilledByPlayer')
						net.WriteEntity(v)
						net.WriteString('qtg_admin_gun')
						net.WriteEntity(owner)
					net.Broadcast()
					MsgAll(owner:Nick()..' killed '..v:Nick()..' using qtg_admin_gun\n')
				end
				local ed = EffectData()
				ed:SetOrigin(v:GetPos())
				ed:SetEntity(v)
				util.QTGEffect('entity_remove',ed,true,true)
			end
		end

		if getlanguage() == 'zh-CN' then
			Text = owner:Name()..'杀死所有玩家'
		else
			Text = owner:Name()..' Kill All Player'
		end

		broadcastNotify(Text,NOTIFY_CLEANUP)
	elseif owner:GetNWInt('AdminGun_FireMode') == 9 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		self:QTGEmitSound(PSOUND_CLEANUP)
		for k, v in entitiesf() do
			if v:IsNPC() or type(v) == 'NextBot' then
				if SERVER then
					v:QTGRemove4(self:QTGGetKey())
					net_Start('PlayerKilledNPC')
						net.WriteString(v:GetClass())
						net.WriteString(self:GetClass())
						net.WriteEntity(owner)
					net.Broadcast()
				end
				local ed = EffectData()
				ed:SetOrigin(v:GetPos())
				ed:SetEntity(v)
				util.QTGEffect('entity_remove',ed,true,true)
			end
		end

		if getlanguage() == 'zh-CN' then
			Text = owner:Name()..'杀死所有NPC'
		else
			Text = owner:Name()..' Kill All NPC'
		end

		broadcastNotify(Text,NOTIFY_CLEANUP)
	elseif owner:GetNWInt('AdminGun_FireMode') == 10 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if !owner:GetNWBool('AdminGun_Invisible') then
			owner:QTGInvisible(true)
			owner:SetNWBool('AdminGun_Invisible',true)
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '隐身模式开启'
			else
				Text = 'Invisible Mode On'
			end
			if SERVER then owner:QTGAddNotify(Text) end
		else
			owner:QTGInvisible(false)
			owner:SetNWBool('AdminGun_Invisible',false)
			self:QTGEmitSound(PSOUND_OFF)
			if getlanguage() == 'zh-CN' then
				Text = '隐身模式关闭'
			else
				Text = 'Invisible Mode Off'
			end
			if SERVER then owner:QTGAddNotify(Text) end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 11 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire( CurTime() + 0.3 )
		self:QTGEmitSound(PSOUND_ON)
		if SERVER then
			for k, v in pairs(player.GetAll()) do
				if v ~= owner then
					v:_QTGSetHealth(GetConVar( 'QTG_AdminGun_SetPlyHealth' ):GetInt(),self:QTGGetKey())
				end
			end

			if getlanguage() == 'zh-CN' then
				Text = owner:Name()..'设置所有玩家血量('..owner:GetNWInt('QTG_AdminGun_SetPlyHealth')..')'
			else
				Text = owner:Name()..' Set All Player Health('..owner:GetNWInt('QTG_AdminGun_SetPlyHealth')..')'
			end
			
			broadcastNotify(Text)
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 12 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		self:QTGEmitSound(PSOUND_CLEANUP)
		for k, v in pairs(ents.FindByClass('gmod_wire_expression2')) do
			if SERVER then
				v:QTGRemove5()
			end
			local ed = EffectData()
			ed:SetOrigin(v:GetPos())
			ed:SetEntity(v)
			util.QTGEffect('entity_remove',ed,true,true)
		end

		if getlanguage() == 'zh-CN' then
			Text = owner:Name()..'删除所有Wire Expression 2实体'
		else
			Text = owner:Name()..' Remove All Wire Expression 2'
		end

		broadcastNotify(Text,NOTIFY_CLEANUP)
	elseif owner:GetNWInt('AdminGun_FireMode') == 13 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		self:QTGEmitSound(PSOUND_CLEANUP)
		for k, v in entitiesf() do
			if v:GetClass() == 'gmod_wire_*' or v:GetClass() == 'wire*' then
				if SERVER then
					v:QTGRemove6()
				end
				local ed = EffectData()
				ed:SetOrigin(v:GetPos())
				ed:SetEntity(v)
				util.QTGEffect('entity_remove',ed,true,true)
			end
		end

		if getlanguage() == 'zh-CN' then
			Text = owner:Name()..'删除所有Wire实体'
		else
			Text = owner:Name()..' Remove All Wire'
		end

		broadcastNotify(Text,NOTIFY_CLEANUP)
	elseif owner:GetNWInt('AdminGun_FireMode') == 14 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if !owner:GetNWBool('AdminGun_WallHack') then
			owner:SetNWBool('AdminGun_WallHack',true)
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '透视模式开启'
			else
				Text = 'Wall Hack Mode On'
			end
			if SERVER then owner:QTGAddNotify(Text) end
		else
			owner:SetNWBool('AdminGun_WallHack',false)
			self:QTGEmitSound(PSOUND_OFF)
			if getlanguage() == 'zh-CN' then
				Text = '透视模式关闭'
			else
				Text = 'Wall Hack Mode Off'
			end
			if SERVER then owner:QTGAddNotify(Text) end
		end	
	elseif owner:GetNWInt('AdminGun_FireMode') == 15 then
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.1*game.GetTimeScale() or CurTime()+0.1)
		self:QTGEmitSound(PSOUND_DEFAULT)
		for k,v in pairs(ents.FindAlongRay(owner:GetShootPos()+owner:GetAimVector()*80,eyetrace.HitPos,Vector(-10,-10,-10),Vector(15,15,15))) do
			if v:IsValid() then
				if v:IsPlayer() and v != owner then
					if v:GetActiveWeaponClass() != 'qtg_admin_gun' then
						if SERVER then
							if v.KillSilent then -- what the fudge
								v:KillSilent()
							end

							net_Start('PlayerKilledByPlayer')
								net.WriteEntity(v)
								net.WriteString('qtg_universal_kill')
								net.WriteEntity(owner)
							net.Broadcast()

							MsgAll(owner:Nick()..' killed '..v:Nick()..' using qtg_admin_gun\n')
						end
						local ed = EffectData()
						ed:SetOrigin(v:GetPos())
						ed:SetEntity(v)
						util.QTGEffect('entity_remove',ed,true,true)
					end
				elseif v != self and !v:IsWeapon() and !v:IsPlayer() and !table.HasValue(dontremeve,v:GetClass()) then
					if SERVER then
						v:QTGRemove50()
						net_Start('PlayerKilledNPC')
							net.WriteString(v:GetClass())
							net.WriteString('qtg_universal_kill')
							net.WriteEntity(owner)
						net.Broadcast()
					end
					
					local ed = EffectData()
					ed:SetOrigin(v:GetPos())
					ed:SetEntity(v)

					util.Effect('entity_remove',ed,true,true)
				end
			end
		end
		local effectdata = EffectData()
		effectdata:SetOrigin(owner:GetEyeTrace().HitPos)
		effectdata:SetNormal(tr.HitNormal)
		effectdata:SetEntity(entity)
		effectdata:SetAttachment( 1 )
		util.QTGEffect('selection_indicator',effectdata)
		local Kill = EffectData()
		Kill:SetOrigin(owner:GetEyeTrace().HitPos)
		Kill:SetStart(owner:GetShootPos())
		Kill:SetAttachment(1)
		Kill:SetEntity(self)
		util.QTGEffect('ToolTracer',Kill,true,nil)
	elseif owner:GetNWInt('AdminGun_FireMode') == 16 then
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.1*game.GetTimeScale() or CurTime()+0.1)
		self:QTGEmitSound(PSOUND_FIREPROP)
		if SERVER then
			for i=1,10 do
				local Forward = owner:EyeAngles():Forward()
				local frag = ents_Create('qtg_grenade_frag')

				if frag:IsValid() then
					frag:SetPos(owner:GetShootPos() + Forward * 20 + owner:GetAimVector()*15 + Vector(math.Rand(10,-10),math.Rand(10,-10),math.Rand(10,-10)) + ( owner:GetRight() * 10 + owner:GetUp() * -10 ))
					frag:SetOwner( owner )
					frag:Spawn()
					frag:Activate()

					local phys = frag:GetPhysicsObject()

					if phys:IsValid() then
						phys:ApplyForceCenter(owner:GetAimVector()*4000)
					end

					frag:SetAngles(owner:EyeAngles() + Angle(90,0,0))
				end
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 17 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if owner:GetNWInt('AdminGun_MovingSpeed') == 0 then
			owner:SetNWInt('AdminGun_MovingSpeed',1)
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '移动速度 X2'
			else
				Text = 'Moving Speed X2'
			end
		elseif owner:GetNWInt('AdminGun_MovingSpeed') == 1 then
			owner:SetNWInt('AdminGun_MovingSpeed',2)
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '移动速度 X4'
			else
				Text = 'Moving Speed X4'
			end
		elseif owner:GetNWInt('AdminGun_MovingSpeed') == 2 then
			owner:SetNWInt('AdminGun_MovingSpeed',3)
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '移动速度 X6'
			else
				Text = 'Moving Speed X6'
			end
		elseif owner:GetNWInt('AdminGun_MovingSpeed') == 3 then
			owner:SetNWInt('AdminGun_MovingSpeed',4)
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '移动速度 X8'
			else
				Text = 'Moving Speed X8'
			end
		elseif owner:GetNWInt('AdminGun_MovingSpeed') == 4 then
			owner:SetNWInt('AdminGun_MovingSpeed',5)
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '移动速度 X10'
			else
				Text = 'Moving Speed X10'
			end
		elseif owner:GetNWInt('AdminGun_MovingSpeed') == 5 then
			owner:SetNWInt('AdminGun_MovingSpeed',0)
			self:QTGEmitSound(PSOUND_OFF)
			if getlanguage() == 'zh-CN' then
				Text = '移动速度关闭'
			else
				Text = 'Moving Speed Off'
			end
		end
		if SERVER then owner:QTGAddNotify(Text) end
	elseif owner:GetNWInt('AdminGun_FireMode') == 18 then
		if !IsMounted('ep2') then
			if getlanguage() == 'zh-CN' then
				Text = owner:Name()..'你的EP2模块无效,请安装和加载EP2模块!'
			else
				Text = owner:Name()..' you are missing the EP2 module, please install and load the EP2 module!'
			end
			if SERVER then owner:QTGAddNotify(Text) end
			self:SetNextPrimaryFire(CurTime()+0.3)
			return 
		end
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(CurTime())
		self:QTGEmitSound(PSOUND_HUNTER)
		if SERVER then
			SuppressHostEvents(NULL)
			local c = owner:EyeAngles()

			for i=1,5 do
				local e = ents_Create('hunter_flechette')

				if e:IsValid() then
					e:SetPos(owner:GetShootPos()+c:Forward()*32+c:Right()*6-c:Up()*4+Vector(math.Rand(10,-10),math.Rand(10,-10),math.Rand(10,-10)))
					e:SetAngles(owner:EyeAngles())
					e:Spawn()
					e:SetVelocity(c:Forward()*2000)
					e:SetOwner(owner)
					e.IsQTGAdminGun = true
					e.Gun = self
				end
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 19 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if !owner:GetNWBool('AdminGun_FlyMode') then
			owner:SetNWBool('AdminGun_FlyMode',true)
			self.qtgjuststartedfly = true
			self:QTGEmitSound(PSOUND_ON)
			if getlanguage() == 'zh-CN' then
				Text = '飞行模式开'
			else
				Text = 'Fly Mode On'
			end
			if SERVER then owner:QTGAddNotify(Text) end
		else
			owner:SetNWInt('AdminGun_FlyMode',false)
			self:QTGEmitSound(PSOUND_OFF)
			if getlanguage() == 'zh-CN' then
				Text = '飞行模式关'
			else
				Text = 'Fly Mode Off'
			end	
			owner:_QTGSetMoveType(MOVETYPE_WALK,owner:QTGGetKey())
			self.qtgjuststartedfly = nil
			if SERVER then owner:QTGAddNotify(Text) end
		end	
	elseif owner:GetNWInt('AdminGun_FireMode') == 20 then
		if !self:CanFireNukeBomb() then return end
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.1*game.GetTimeScale() or CurTime()+0.1)
		self:QTGEmitSound(PSOUND_FIREPROP)
		if SERVER then
			local Forward = owner:EyeAngles():Forward()
			local ent = ents_Create('qtg_nuke_bomb')
			if IsValid( ent ) then
				ent:SetPos( owner:GetShootPos() + Forward * 32 )
				ent:SetAngles( owner:EyeAngles() )
				ent:Spawn()
				ent:SetOwner(owner)

				local phys = ent:GetPhysicsObject()

				if phys:IsValid() then 
					phys:Wake() 
					phys:SetVelocity(ent:GetForward() * 1500) 
				end
			end
		end	
	elseif owner:GetNWInt('AdminGun_FireMode') == 21 then
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.1*game.GetTimeScale() or CurTime()+0.1)
		self:QTGEmitSound(PSOUND_FIREPROP)
		if SERVER then
			local f = owner:EyeAngles():Forward()
			local e = ents_Create('grenade_helicopter')
			if IsValid(e) then
				e:SetPos(owner:GetShootPos()+f*32)
				e:SetAngles(owner:EyeAngles())
				e:Spawn()
				e:SetOwner(owner)

				local p = e:GetPhysicsObject()

				if p:IsValid() then
					e:GetPhysicsObject():SetVelocity(f*1e9)
				end

				e.IsQTGAdminGun = true
				e.Gun = self
			end
		end	
	elseif owner:GetNWInt('AdminGun_FireMode') == 22 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if !owner:GetNWBool('AdminGun_SlowTime') then
			owner:SetNWBool('AdminGun_SlowTime',true)
			self:QTGEmitSound(PSOUND_ON)

			if getlanguage() == 'zh-CN' then
				Text = owner:Name()..'开启了慢速时间'
			else
				Text = owner:Name()..' On Slow Time'
			end

			broadcastNotify(Text)

			if SERVER then
				game.SetTimeScale(0.25)
			end
			owner:SetNWBool('AdminGun_SpeedTime',false)		
			owner:SetNWBool('AdminGun_TimeStop',false)
			if SERVER then
				QTG_TimeStart()
			end
		else
			owner:SetNWBool('AdminGun_SlowTime',false)
			self:QTGEmitSound(PSOUND_OFF)

			if getlanguage() == 'zh-CN' then
				Text = owner:Name()..'关闭了慢速时间'
			else
				Text = owner:Name()..' Off Slow Time'
			end
			
			broadcastNotify(Text)

			if SERVER then
				game.SetTimeScale(1)
			end
		end	
	elseif owner:GetNWInt('AdminGun_FireMode') == 23 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if !owner:GetNWBool('AdminGun_SpeedTime') then
			owner:SetNWBool('AdminGun_SpeedTime',true)
			self:QTGEmitSound(PSOUND_ON)

			if getlanguage() == 'zh-CN' then
				Text = owner:Name()..'开启了加速时间'
			else
				Text = owner:Name()..' On Speed Time'
			end
			
			broadcastNotify(Text)
			
			if SERVER then
				game.SetTimeScale(1.75)
			end
			owner:SetNWBool('AdminGun_SlowTime',false)
			owner:SetNWBool('AdminGun_TimeStop',false)
			if SERVER then
				QTG_TimeStart()
			end
		else
			owner:SetNWBool('AdminGun_SpeedTime',false)
			self:QTGEmitSound(PSOUND_OFF)

			if getlanguage() == 'zh-CN' then
				Text = owner:Name()..'关闭了加速时间'
			else
				Text = owner:Name()..' Off Speed Time'
			end

			broadcastNotify(Text)
			
			if SERVER then
				game.SetTimeScale(1)
			end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 24 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.1*game.GetTimeScale() or CurTime()+0.1)
		local target = Ftr(self,1e9).HitPos
		owner:_QTGSetPos(target,self:QTGGetKey())
		self:QTGEmitSound(PSOUND_DEFAULT)
	elseif owner:GetNWInt('AdminGun_FireMode') == 25 then
		self.Primary.Automatic = false
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.3*game.GetTimeScale() or CurTime()+0.3)
		if !owner:GetNWBool('AdminGun_Defense') then
			owner:SetNWBool('AdminGun_Defense',true)
			self:QTGEmitSound(PSOUND_ON)
			if SERVER then
				local e = ents_Create('qtg_ent_barrier')

				if e:IsValid() then
					e:Spawn()
					e:Activate()
					e:SetOwner(owner)
				end
			end
			if getlanguage() == 'zh-CN' then
				Text = '防御开启'
			else
				Text = 'Defense On'
			end
			if SERVER then owner:QTGAddNotify(Text) end
		else
			owner:SetNWBool('AdminGun_Defense',false)
			self:QTGEmitSound(PSOUND_OFF)
			if getlanguage() == 'zh-CN' then
				Text = '防御关闭'
			else
				Text = 'Defense Off'
			end
			if SERVER then owner:QTGAddNotify(Text) end
		end
	elseif owner:GetNWInt('AdminGun_FireMode') == 26 then
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.05*game.GetTimeScale() or CurTime()+0.05)
		self:QTGEmitSound(PSOUND_DEFAULT)
		if SERVER then
			local c = owner:EyeAngles()
			local e = ents_Create('qtg_ent_bullet')
			if e:IsValid() then
				e:SetPos(owner:GetShootPos()+c:Forward()*0+c:Right()*6-c:Up()*4)
				e:SetAngles(owner:EyeAngles())
				e:Spawn()
				e:SetOwner(owner)

				local ph = e:GetPhysicsObject()

				if ph:IsValid() then
					ph:SetVelocity(c:Forward()*1e9)
				end
			end
		end	
	elseif owner:GetNWInt('AdminGun_FireMode') == 27 then
		self.Primary.Automatic = true
		self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime()+0.25*game.GetTimeScale() or CurTime()+0.25)
		self:QTGEmitSound(PSOUND_FIREPROP)
		if SERVER then
			local c = owner:EyeAngles()
			local e = ents_Create('qtg_ent_timestop_bomb')
			if e:IsValid() then
				e:SetPos(owner:GetShootPos()+c:Forward()*0+c:Right()*6-c:Up()*4)
				e:SetAngles(owner:EyeAngles())
				e:Spawn()
				e:SetOwner(owner)

				local ph = e:GetPhysicsObject()

				if ph:IsValid() then
					ph:SetVelocity(c:Forward()*1e9)
				end
			end
		end	
	end
end
	
function SWEP:SecondaryAttack()
	if isttt then return end
	local owner = self:GetOwner()
	if !owner:IsValid() or !owner:IsAdmin() then return end
	if owner:IsNPC() then
		owner:NpcFire()
	else
		if !owner:GetNWBool('AdminGun_Invisible') then
			self:QTGEmitSound(PSOUND_MODE)
		end
		if SERVER then
			net_Start('QTG_OpenMenu')
			net.Send(owner)
		end
	end
end

if SERVER then
	net.Receive('QTG_AGSMH',function(_,p)
		if !p:IsValid() then return end

		local p = net.ReadEntity()

		if IsValid(p) then
			p:SetNWInt('QTG_AdminGun_SetMyHealth',net.ReadFloat())
		end
	end)
	net.Receive('QTG_AGSPH',function(_,p)
		if !p:IsValid() then return end

		local p = net.ReadEntity()

		if IsValid(p) then
			p:SetNWInt('QTG_AdminGun_SetPlyHealth',net.ReadFloat())
		end
	end)

	local isfunction = isfunction

	net.Receive('QTG_NPCD',function(_,p)
		if !p:IsValid() then return end

		local n = net.ReadEntity()
		if !IsValid(n) then return end

		if !n:IsNPC() then
			n:SetNWInt('QTG_AdminGun_IsGoodNpc',0)
			return
		end

		local get = n.Disposition

		if isfunction(get) then
			local disp = get(n,p)

			if disp == D_LI then
				n:SetNWInt('QTG_AdminGun_IsGoodNpc',1)
			elseif disp == D_NU then
				n:SetNWInt('QTG_AdminGun_IsGoodNpc',2)
			else
				n:SetNWInt('QTG_AdminGun_IsGoodNpc',0)
			end
		end
	end)

	net.Receive('QTG_SetServer',function(_,p)
		if p:IsValid() then
			p:SetNWInt('AdminGun_FireMode',net.ReadFloat())
		end
	end)
	net.Receive('QTG_ReturnServer',function(_,p)
		if p:IsValid() then
			p:SetNWInt('AdminGun_Notice',net.ReadFloat())
		end
	end)
else
	local missmat = Material('undertale/qtg_miss')
	local count = 0

	timer.Create('qtg_miss_reset_count',2,0,function()
		count = 0
	end)

	net.Receive('QTG_miss', function()
		if count > 750 then return end

		local p = net.ReadEntity()
		local v = net.ReadVector()

		local e = ParticleEmitter(v,false)
		if !e then return end

		local p = e:Add(missmat,v)

		count = count + 1
		
		if p then
			p:SetVelocity(Vector( 0, 0, 10 ))
			p:SetColor(255,255,255) 
			p:SetLifeTime(0)
			p:SetDieTime(2)
			p:SetStartSize(20)
			p:SetEndSize(20)
			p:SetStartAlpha(255)
			p:SetEndAlpha(0)
			p:SetGravity(Vector(0,0,0))
		end
		e:Finish()
	end)
end

if CLIENT then
	local processDelay1 = CurTime() + 0.1
	local processDelay2 = CurTime() + 0.1

	local Text1 = ''
	local Text2 = ''

	local function getinfocounts()
		local e2,wire,ply,npc = 0,0,0,0

		for k, v in entitiesf() do
			if v:IsNPC() or v:IsNextBot() then
				npc = npc + 1
			elseif v != p and v:IsPlayer() and v:Alive() and v:GetActiveWeaponClass() != 'qtg_admin_gun' then
				ply = ply + 1
			else
				local class = v:GetClass()
				
				if string.StartsWith(class, 'gmod_wire_') or string.StartsWith(class, 'wire') then
					wire = wire + 1
				elseif class == 'gmod_wire_expression2' then
					e2 = e2 + 1
				end
			end
		end	

		return e2,wire,npc,ply
	end

	-- Auto Icons
	-- https://steamcommunity.com/sharedfiles/filedetails/?id=2495300496
	local wepSelectIcon = Material('entities/qtg_admin_gun_icon.png')
	wepSelectIcon:SetVector('$color2', Vector(1, 0.93, 0.05))

	function SWEP:DrawWeaponSelection( x, y, wide, tall, alpha )
		if !x or !y or !wide or !tall then return end

		y = y + 10
		x = x + 10
		wide = wide -20
		tall = tall -20
		fsin = math.sin( CurTime() * 10 ) * 5
		draw.SimpleText(self:ModeText(1),'HudSelectionText',x + wide/2, y + tall - (tall / 11),Color(0,255,0,255),TEXT_ALIGN_CENTER,TEXT_ALIGN_BOTTOM)

		local s = 200
		local shift = math.floor(tall / 4)

		surface.SetDrawColor(255, 0, 255, alpha)
		render.SetMaterial(wepSelectIcon)
		render.SetWriteDepthToDestAlpha( false )
		render.OverrideBlend(true, BLEND_ONE_MINUS_DST_COLOR, BLEND_ONE, BLENDFUNC_ADD, BLEND_ZERO, BLEND_ONE, BLENDFUNC_ADD)
		render.DrawScreenQuadEx(x + (wide - s) * 0.5, (y + shift) + ((tall - shift) - s) * 0.5, s, s)
		render.OverrideBlend(false)
		render.SetWriteDepthToDestAlpha( true)

		--surface.DrawTexturedRect( x + wide/4 + 0.5,y - fsin,wide / 2,wide / 2)
		self:DrawWeaponInfo( x + wide + 20, y + tall * 0.95, wide, tall - (tall / 3), alpha - 50 )
	end
	
	function SWEP:DrawWeaponInfo( x, y, wide, tall, alpha )
		local AuthorName = self.Author
		local Title_Color = Color(0,255,255,alpha)
		local Text_Color = Color(math.random(0, 255),math.random(0, 255),math.random(0, 255),255)
		local Text_Color2 = Color(0,0,0,alpha)
		local BGColor = Color(100,100,100,alpha)
		local Text = ''
		local Text2 = ''
		local Text3 = ''
		local Text4 = ''
		local Text8,Text6,Text5,Text7 = getinfocounts()
		local Author = QAGL.InfoAuthor
		local Text = QAGL.InfoNpc
		local Text2 = QAGL.InfoWire
		local Text3 = QAGL.InfoPly
		local Text4 = QAGL.InfoE2
		surface.SetDrawColor(BGColor)
		surface.SetTexture(self.SpeechBubbleLid)
		surface.DrawTexturedRect(x,y-64-5,128,64)
		draw.RoundedBox(8,x-5,y-6,260,tall,BGColor)
		draw.SimpleText(Author,'HudSelectionText',x+5,y+tall/5,Title_Color,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(AuthorName,'HudSelectionText',x+wide/3,y+tall/5,Text_Color,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text,'HudSelectionText', x+5,y+tall-(tall/1.55),Title_Color,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text2,'HudSelectionText',x+5,y+tall-(tall/2),Title_Color,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text3,'HudSelectionText',x+5,y+tall-(tall/2.9),Title_Color,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text4,'HudSelectionText',x+5,y+tall-(tall/5),Title_Color,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text5,'HudSelectionText',x+wide/3,y+tall-(tall/1.55),Text_Color2,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text6,'HudSelectionText',x+wide/3,y+tall-(tall/2),Text_Color2,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text7,'HudSelectionText',x+wide/3,y+tall-(tall/2.9),Text_Color2,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
		draw.SimpleText(Text8,'HudSelectionText',x+wide/3,y+tall-(tall/5),Text_Color2,TEXT_ALIGN_LEFT,TEXT_ALIGN_BOTTOM)
	end

	function SWEP:ModeText(b)
		local owner = self:GetOwner()

		if not owner:IsValid() then
			Text1 = ''
			Text2 = ''
			
			return
		end

		if b == 1 then
			if CurTime() > processDelay1 then
				processDelay1 = CurTime() + 0.1

				local Mode = owner:GetNWInt('AdminGun_FireMode')
				local e2,wire,SerPly,SerNpc = getinfocounts()

				Text1 = ''

				if Mode == 0 then
					Text1 = QAGL.Default
				elseif Mode == 1 then
					Text1 = QAGL.Explosion
				elseif Mode == 2 then
					Text1 = QAGL.Fire
				elseif Mode == 3 then
					Text1 = QAGL.Crossbow
				elseif Mode == 4 then
					Text1 = QAGL.CombineBall
				elseif Mode == 5 then
					Text1 = QAGL.Grenade
				elseif Mode == 6 then
					Text1 = QAGL.RPG
				elseif Mode == 7 then	
					Text1 = owner:GetNWBool('AdminGun_TimeStop') and QAGL.TimeStopOn or QAGL.TimeStopOff
				elseif Mode == 8 then		
					Text1 = QAGL.KillAllPLY
				elseif Mode == 9 then	
					Text1 = QAGL.KillAllNPC
				elseif Mode == 10 then
					Text1 = owner:GetNWBool('AdminGun_Invisible') and QAGL.InvisibleOn or QAGL.InvisibleOff
				elseif Mode == 11 then
					Text1 = QAGL.SetAllPlayerHeath..'('..owner:GetNWInt('QTG_AdminGun_SetPlyHealth')..')'
				elseif Mode == 12 then	
					Text1 = QAGL.RemoveAllWireE2
				elseif Mode == 13 then	
					Text1 = QAGL.RemoveAllWire
				elseif Mode == 14 then	
					Text1 = owner:GetNWBool('AdminGun_WallHack') and QAGL.WallHackOn or QAGL.WallHackOff
				elseif Mode == 15 then	
					Text1 = QAGL.UniversalKill
				elseif Mode == 16 then
					Text1 = QAGL.FragGrenade
				elseif Mode == 17 then
					local MovingSpeed = owner:GetNWInt('AdminGun_MovingSpeed')

					if MovingSpeed == 0 then
						Text1 = QAGL.MovingSpeedOff
					elseif MovingSpeed == 1 then
						Text1 = QAGL.MovingSpeedX2
					elseif MovingSpeed == 2 then
						Text1 = QAGL.MovingSpeedX4
					elseif MovingSpeed == 3 then
						Text1 = QAGL.MovingSpeedX6
					elseif MovingSpeed == 4 then
						Text1 = QAGL.MovingSpeedX8
					elseif MovingSpeed == 5 then
						Text1 = QAGL.MovingSpeedX10
					end
				elseif Mode == 18 then
					Text1 = QAGL.Flechette
				elseif Mode == 19 then
					Text1 = owner:GetNWBool('AdminGun_FlyMode') and QAGL.FlyOn or QAGL.FlyOff
				elseif Mode == 20 then
					Text1 = self:CanFireNukeBomb() and QAGL.NukeBombReady or QAGL.NukeBombNotReady
				elseif Mode == 21 then
					Text1 = QAGL.HelicopterBomb
				elseif Mode == 22 then
					Text1 = owner:GetNWBool('AdminGun_SlowTime') and QAGL.SlowTimeOn or QAGL.SlowTimeOff
				elseif Mode == 23 then
					Text1 = owner:GetNWBool('AdminGun_SpeedTime') and QAGL.SpeedTimeOn or QAGL.SpeedTimeOff
				elseif Mode == 24 then
					Text1 = QAGL.Teleport
				elseif Mode == 25 then
					Text1 = owner:GetNWBool('AdminGun_Defense') and QAGL.DefenseOn or QAGL.DefenseOff
				elseif Mode == 26 then
					Text1 = QAGL.PhysicalBullet
				elseif Mode == 27 then
					Text1 = QAGL.TimeStopBomb
				end
			end

			return Text1
		end

		if b == 2 then
			if CurTime() > processDelay2 then
				processDelay2 = CurTime() + 0.1

				local Mode = owner:GetNWInt('AdminGun_FireMode')
				local e2,wire,SerPly,SerNpc = getinfocounts()

				Text2 = ''

				if Mode == 0 then
					if self:GetFireType() == 0 then
						Text2 = QAGL.DefaultType1
					elseif self:GetFireType() == 1 then
						Text2 = QAGL.DefaultType2
					elseif self:GetFireType() == 2 then
						Text2 = QAGL.DefaultType3
					end
				end
				if Mode == 4 then
					if self:GetFireType() == 0 then
						Text2 = QAGL.CombineBallType1
					elseif self:GetFireType() == 1 then
						Text2 = QAGL.CombineBallType2
					end
				end
				if Mode == 6 then
					if self:GetFireType() == 0 then
						Text2 = QAGL.RPGType1
					elseif self:GetFireType() == 1 then
						Text2 = QAGL.RPGType2
					end
				end
				if Mode == 9 then
					if SerNpc == 0 then
						Text2 = ''
					elseif SerNpc == 1 then
						Text2 = QAGL.FindNpc
					elseif SerNpc != 0 and SerNpc != 1 then
						Text2 = QAGL.FindNpcN..': '..SerNpc
					end
				end	
				if Mode == 8 or Mode == 11 then
					if SerPly == 0 then
						Text2 = ''
					elseif SerPly == 1 then
						Text2 = QAGL.FindPly
					elseif SerPly != 0 and SerPly != 1 then
						Text2 = QAGL.FindPlyN..': '..SerPly
					end
				end	
				if Mode == 12 then
					if e2 == 0 then
						Text2 = ''
					elseif e2 == 1 then
						Text2 = QAGL.FindE2
					elseif e2 != 0 and e2 != 1 then
						Text2 = QAGL.FindE2N..': '..e2
					end	
				end
				if Mode == 13 then
					if wire == 0 then
						Text2 = ''
					elseif wire == 1 then
						Text2 = QAGL.FindWire
					elseif wire != 0 and wire != 1 then
						Text2 = QAGL.FindWireN..': '..wire
					end
				end
			end

			return Text2
		end
	end
end

local color_red = Color(255, 0, 0)

function SWEP:Think()
	local o = self:GetOwner()
	local isValid = IsValid(o)

	if o:IsPlayer() and !self.QTG_Initialized then
		self:Initialize()
	end

	if SERVER and isValid and o:IsPlayer() then
		local rainbow = o.QTG_AdminGun_GunRainbowLaser_Cvar
		local playerRainbow = o.QTG_AdminGun_GunMakePlayerRainbow_Cvar

		self:SetNWBool('LaserRainbow', rainbow == '1' and true or false)
		self:SetNWBool('PlayerRainbow', playerRainbow == '1' and true or false)
		self:SetNWString('LaserColor', o.QTG_AdminGun_GunLaserColor_Cvar)

		local idletime = self.QTG_NextVM_Idle or 0

		if CurTime() > idletime then
			local vm = o:GetViewModel()

			--print(vm)

			if vm:IsValid() then
				vm:SendViewModelMatchingSequence(vm:LookupSequence('idle01'))
				vm:SetPlaybackRate(4)
			end
	
			self:UpdateNextIdle()
		end
	end

	if !isttt then
		if SERVER and isValid then
			if o:GetNWBool('AdminGun_FlyMode') then
				o:RemoveFlags(1) -- Remove FL_ONGROUND flag
			end

			if o:GetNWInt('AdminGun_MovingSpeed') == 0 and self.OldRunSpeed then
				o:SetRunSpeed(self.OldRunSpeed)
				o:SetWalkSpeed(self.OldWalkSpeed)
				o:SetJumpPower(self.OldJumpPower)
			elseif o:GetNWInt('AdminGun_MovingSpeed') == 1 then
				o:SetWalkSpeed(800)
				o:SetRunSpeed(800)
				o:SetJumpPower(500)
			elseif o:GetNWInt('AdminGun_MovingSpeed') == 2 then
				o:SetWalkSpeed(1600)
				o:SetRunSpeed(1600)
				o:SetJumpPower(1000)
			elseif o:GetNWInt('AdminGun_MovingSpeed') == 3 then
				o:SetWalkSpeed(3200)
				o:SetRunSpeed(3200)
				o:SetJumpPower(2000)
			elseif o:GetNWInt('AdminGun_MovingSpeed') == 4 then
				o:SetWalkSpeed(6400)
				o:SetRunSpeed(6400)
				o:SetJumpPower(4000)
			elseif o:GetNWInt('AdminGun_MovingSpeed') == 5 then
				o:SetWalkSpeed(12800)
				o:SetRunSpeed(12800)
				o:SetJumpPower(8000)
			end

			local hitSource = o:GetPos()
			if !o:IsPlayer() or o.QTG_AdminGun_GunDestroy_Cvar == '1' then
				for _,e in pairs(ents.FindInSphere(hitSource,70)) do
					if e:IsValid() then
						local class = e:GetClass()

						if ReplaceList[class] then
							local d = ents_Create('prop_physics')

							e:Remove()

							if d:IsValid() then
								d:SetModel(e:GetModel() or '')
								d:SetPos(e:GetPos())
								d:SetAngles(e:GetAngles())
								d:Spawn()
								d:Activate()
								if e:GetSkin() != nil then
									d:SetSkin(e:GetSkin())
								end
								d:SetMaterial(e:GetMaterial() or '')
								timer.Simple(3,function()
									if IsValid(d) then
										d:SetCollisionGroup(1)
									end
								end)
								local phys = d:GetPhysicsObject()
								if phys:IsValid() then
									phys:SetVelocity(((d:GetPos()-self:GetPos())*500+(d:GetPos()+d:GetForward()*400-self:GetPos())+(d:GetPos()+d:GetUp()*200-self:GetPos())*140))
								end
							end
						elseif ReplaceList2[class] then
							local d = ents_Create('prop_physics')

							e:Remove()

							if d:IsValid() then
								d:SetModel(e:GetModel() or '')
								d:SetPos(e:GetPos())
								d:SetAngles(e:GetAngles())
								d:Spawn()
								d:Activate()
								if e:GetSkin() != nil then
									d:SetSkin(e:GetSkin())
								end
								d:SetMaterial(e:GetMaterial() or '')
								local phys = d:GetPhysicsObject()
								if phys:IsValid() then
									phys:SetVelocity(((d:GetPos()-self:GetPos())*500+(d:GetPos()+d:GetForward()*400-self:GetPos())+(d:GetPos()+d:GetUp()*200-self:GetPos())*140))
								end
							end
						end

						if class == 'func_brush' and e:GetName() != '' then
							e:Remove()
						end
					end				
				end	
			end

			for k, v in pairs(ents.FindInSphere(hitSource,150)) do
				if IsValid(v) and v:GetClass() == 'ent_undertale_bone_ground' then
					v:SetSolid(SOLID_NONE)
				end
			end

			for k,v in entitiesf() do
				if v:GetClass() == 'npc_barnacle' then
					local p1 = o:GetPos()
					local p2 = v:GetPos()

					if math.Distance(p1.x,p1.y,p2.x,p2.y) <= 100 then
						v:NextThink(CurTime()+3)
					end
				end
			end

			if issandbox then
				if !o:IsNPC() and o:IsAdmin() then
					if !self:GetHolstering() then
						o:QTGSuperGODEnable()
					end
					
					o:Extinguish()
				else
					o:_QTGSetHealth(1e9,o:QTGGetKey())
				end
			end
		elseif !o:IsNPC() then
			if isValid then
				net_Start('QTG_AGSMH')
					net.WriteEntity(o)
					net.WriteFloat(GetConVar('QTG_AdminGun_SetMyHealth'):GetInt())
				net.SendToServer()
				net_Start('QTG_AGSPH')
					net.WriteEntity(o)
					net.WriteFloat(GetConVar('QTG_AdminGun_SetPlyHealth'):GetInt())
				net.SendToServer()
			end
		end
	end

	if isValid and !o:IsNPC() then
		if self:GetZoomLvl() != 0 then
			self.DrawCrosshair = false
		else
			self.DrawCrosshair = true
		end
		self:UpdateLaserPosition(o)
		if self:GetHolstering() then
			--print(self,self.QTG_FinishHolsterOnGoing,self:GetNWFloat('QTG_HolsterTime'),)
			if !self.QTG_FinishHolsterOnGoing and self:GetNWFloat('QTG_Holstertime')<CurTime() then
				self.QTG_FinishHolsterOnGoing = true
				self:FinishHolster()
			end
		end
		local dist = o:GetVelocity():LengthSqr()
		if o:KeyDown(IN_SPEED) and dist > o:GetWalkSpeed()^2 then
			self:SetNWBool('QTG_Running',true)
		elseif self:GetNWBool('QTG_Running') then
			self:SetNWBool('QTG_Running',false)
		end
	end
end

function SWEP:WeaponThink()
	local o = self:GetOwner()

	if IsValid(o) then 
		if o:IsPlayer() then
			local picke = o:GetInternalVariable('m_hUseEntity')
			local v = o.qtgisholdinge

			if IsValid(picke) then
				if !v then
					o:SetNW2Bool('QTG_IsHoldingEntity',true)
					o.qtgisholdinge = true
				end
			else
				if v then
					o:SetNW2Bool('QTG_IsHoldingEntity',false)
					o.qtgisholdinge = nil
				end
			end
		end
	else
		for _,e in ipairs(ents.FindInSphere(self:GetPos(),10)) do
			if e:IsPlayer() and e:IsAdmin() then
				e:Give('qtg_admin_gun')
				self:QTGRemove100()
			end
		end
	end
end

if CLIENT then
	local function draw_Circle( x, y, radius, seg )
		local cir = {}
		table.insert( cir, { x = x, y = y, u = 0.5, v = 0.5 } )
		for i = 0, seg do
			local a = math.rad( ( i / seg ) * -360 )
			table.insert( cir, { x = x + math.sin( a ) * radius, y = y + math.cos( a ) * radius, u = math.sin( a ) / 2 + 0.5, v = math.cos( a ) / 2 + 0.5 } )
		end
		local a = math.rad( 0 )
		table.insert( cir, { x = x + math.sin( a ) * radius, y = y + math.cos( a ) * radius, u = math.sin( a ) / 2 + 0.5, v = math.cos( a ) / 2 + 0.5 } )
		surface.DrawPoly( cir )
	end
	
	local h_ap = 0

	local cl_drawhud = GetConVar('cl_drawhud')

	local Scope = surface.GetTextureID('neptune_qtg/sprites/scope')
	local Gradient = surface.GetTextureID('Neptune_QTG/gui/gradient_reverse')

	local gradc1 = Color(10,10,10,180)
	local gradc2 = Color(10,10,10,230)

	local nc = 150/255
	
	function SWEP:DrawHUD()
		if isttt then return end
		if !cl_drawhud:GetBool() then return end

		local o = self:GetOwner()
		if !o:IsValid() or o:InVehicle() or o:GetNW2Bool('QTG_IsHoldingEntity') then return end

		local sw = ScrW()
		local sh = ScrH()

		if self:GetCrosshair() then
			local x = sw / 2
			local y = sh / 2
			
			surface.SetDrawColor(0, 0, 0)
			
			local ls = x - y + 2
			
			surface.DrawRect(0, 0, ls, sh)
			surface.DrawRect(x + y - 2, 0, ls, sh)
			
			surface.DrawLine(0, 0, sw, 0)
			surface.DrawLine(0, sh - 1, sw, sh - 1)
			
			local weight = 5
			local gap = 80
			
			surface.DrawRect(ls, y - weight / 2, y - gap, weight)
			surface.DrawRect(x - weight / 2, y + gap, weight, y - gap)
			surface.DrawRect(x + gap, y - weight / 2, y - gap, weight)
			
			surface.DrawLine(x - gap, y - 1, x + gap, y - 1)
			surface.DrawLine(x - 1, 0, x - 1, y + gap)
			
			surface.SetDrawColor(255, 0, 0)
			draw_Circle(x, y - 1, 2, 48)
			
			surface.SetTexture(Scope)
			surface.SetDrawColor(255, 255, 255)
			
			surface.DrawTexturedRectRotated(x, y, sh, sh, 0)
		end

		local text = {}
		local quad = {}
		local quad2 = {}
		local drawply = LocalPlayer():ShouldDrawLocalPlayer()
		local pos = {x = sw/2, y = sh/2}

		if drawply then
			local att = self:GetAttachment(1)
			if att then
				pos = att.Pos:ToScreen()
			end
		else
			local vm = o:GetViewModel()

			if vm:IsValid() then
				local att = vm:GetAttachment(1)
				
				if att then
					pos = att.Pos:ToScreen()
				end
			end
		end
		
		quad.texture = Gradient
		quad.color = gradc1
		quad.x = sw - 600
		quad.y = sh - (sh/10.5)
		quad.w = 600
		quad.h = 98
		
		quad2.texture = Gradient
		quad2.color = gradc2
		quad2.x = sw - 600
		quad2.y = sh - (sh/8.5)
		quad2.w = 600
		quad2.h = 25

		draw.TexturedQuad(quad)

		if self:ModeText(2) != '' then
			draw.TexturedQuad(quad2)
		end
		
		text.font = 'ModeFont'

		if getlanguage() == 'zh-cn' then
			text.pos = {sw - 25,sh - (sh/17)}
		else
			text.pos = {sw - 25,sh - (sh/21)}
		end

		text.text = self:ModeText(1)
		text.xalign = TEXT_ALIGN_RIGHT
		text.yalign = TEXT_ALIGN_CENTER

		draw.TextShadow(text, 3)
		
		text.font = 'Mode2Font'
		text.pos = {sw - 25,sh * 0.89}
		text.text = self:ModeText(2)
		text.xalign = TEXT_ALIGN_RIGHT
		text.yalign = TEXT_ALIGN_CENTER

		draw.TextShadow(text, 3)

		if o:Alive() and self:GetNWInt('QTG_DeployGunTextTime') < CurTime() and !self:GetHolstering() and GetConVar('QTG_AdminGun_GunText'):GetBool() and self:GetZoomLvl() == 0 and (!o:GetNWBool('AdminGun_Invisible') or !drawply) then
			local x,y = pos.x-20,pos.y+10
			text.font = 'Mode3Font'
			text.pos = {x,y}
			text.text = self:ModeText(1)
			text.xalign = TEXT_ALIGN_RIGHT
			text.yalign = TEXT_ALIGN_CENTER

			draw.TextShadow(text,3)
			
			text.font = 'Mode4Font'
			text.pos = {x,y-20}
			text.text = self:ModeText(2)
			text.xalign = TEXT_ALIGN_RIGHT
			text.yalign = TEXT_ALIGN_CENTER

			draw.TextShadow(text,3)
		end

		if o:Alive() then
			cam.Start3D()
				if o:GetNWBool('AdminGun_WallHack') then
					for k,v in entitiesf() do
						if v:GetPos():ToScreen().visible then
							local isnpc = v:IsNPC()

							if isnpc or type(v) == 'NextBot' then
								net_Start('QTG_NPCD')
									net.WriteEntity(v)
								net.SendToServer()
									
								v:SetMaterial('models/wireframe')
								
								render.SetColorModulation(1,1,1)
								render.SetBlend(1)

								if isnpc then
									local dt = v:GetNWInt('QTG_AdminGun_IsGoodNpc')

									if dt==1 then
										render.SetColorModulation(0,1,0) 
									elseif dt==2 then
										render.SetColorModulation(1,nc,0)
									else
										render.SetColorModulation(1,0,0)
									end
								end
										
								v:DrawModel()
								v:SetColor(color_white)
								v:SetMaterial('')
							elseif v != o and v:IsPlayer() and v:Alive() then
								local color = team.GetColor(v:Team())
									
								v:SetMaterial('models/wireframe')	
									
								render.SetColorModulation(color.r/255, color.g /255, color.b /255)
								render.SetBlend(color.a / 255) 
									
								v:DrawModel()
								v:SetColor(color_white)
								v:SetMaterial('')
							end
						end
					end
				else
					for k,v in entitiesf() do
						if v:GetNoDraw() and (v:IsNPC() or v:IsNextBot()) and v:GetPos():ToScreen().visible then
							v:DrawModel()
						end
					end
				end
			cam.End3D()
		end
	end
	
	function SWEP:AdjustMouseSensitivity()
		return self.Primary.MouseSensitivity[self:GetZoomLvl()]
	end
end

function SWEP:StartGuiding()
	if CLIENT or !self:IsValid() then return end

	local e = self:GetOwner()

	if e:IsValid() and !e:IsNPC() then
		e:EmitSound(RPGLaserOn)
		self:CreateLaserPointer(e)
	end
end

function SWEP:CreateLaserPointer(e)
	if SERVER and !IsValid(self.LaserDot) then
		local laserdot = ents_Create('env_laserdot')

		if IsValid(laserdot) then
			laserdot:SetPos(self:GetPos())
			laserdot:SetOwner(e)
			laserdot:Spawn()
			laserdot:SetNoDraw(true)

			self.LaserDot = laserdot

			self:UpdateLaserPosition(e)
		end
	end
end

function SWEP:UpdateLaserPosition(e)
	if SERVER then
		local laserdot = self.LaserDot

		if laserdot and laserdot:IsValid() then
			local t = e:GetEyeTrace()
			local c = e:EyeAngles()

			laserdot:SetPos(t.HitPos+c:Forward()*-64)
			laserdot:SetAngles((self.Owner:GetAimVector()+(t.HitNormal*1.0)):Angle())
		end
	end
end

function SWEP:StopGuiding(nosound)
	local e = self:GetOwner()

	if SERVER and !e:IsNPC() and e:IsValid() then
		if !nosound then
			e:EmitSound(RPGLaserOff)
		end

		local laserdot = self.LaserDot

		if laserdot and laserdot:IsValid() then
			laserdot:Remove()

			self.LaserDot = NULL
		end
	end
end

function SWEP:Deploy()
	local o = self:GetOwner()
	if !o:IsValid() then return end

	if o:IsPlayer() then
		local vm = o:GetViewModel()

		if IsValid(vm) then
			vm:SetModel(self.ViewModel)
		end

		if o:Alive() then
			if SERVER then
				self.OldRunSpeed = o:GetRunSpeed()
				self.OldWalkSpeed = o:GetWalkSpeed()
				self.OldJumpPower = o:GetJumpPower()

				if issandbox then
					if !o:IsAdmin() then
						if getlanguage() == 'zh-CN' then
							Text = o:Name() .. '你不是管理员禁止使用这个武器!'
						else
							Tezt = o:Name() .. ' you are not an administrator unable to use this weapon!'
						end
						if SERVER then o:QTGAddNotify(Text) end
						o:Kill()
					elseif !o:IsNPC() then
						if !o.QTGGun_Original_Health then
							o.QTGGun_Original_Health = o:Health()
						end

						o:QTGSuperGODEnable()
					end
					o:UnLock()
				end
				if o:GetNWBool('AdminGun_Invisible') then
					o:QTGInvisible(true)
				end
				if o:GetNWBool('AdminGun_Defense') and !o:GetNWBool('AdminGun_BarrierSpawn') then
					if SERVER then
						local e = ents_Create('qtg_ent_barrier')

						if e:IsValid() then
							e:Spawn()
							e:Activate()
							e:SetOwner(o)
						end
					end
				end
			end

			if CLIENT then
				net_Start('QTG_AGSMH')
					net.WriteEntity(o)
					net.WriteFloat(GetConVar('QTG_AdminGun_SetMyHealth'):GetInt())
				net.SendToServer()

				net_Start('QTG_AGSPH')
					net.WriteEntity(o)
					net.WriteFloat(GetConVar('QTG_AdminGun_SetPlyHealth'):GetInt())
				net.SendToServer()
			end
		end
	end

	self:SetFireType(0)
	self:SetZoom(0)
	self:SetCrosshair(false)
	self:SetZoomLvl(0)
	self:SetHoldType(self.HoldType)
	self:SetNWFloat('QTG_DeployTime',game.GetTimeScale()<1 and CurTime() + 0.8 * game.GetTimeScale() or CurTime() + 0.8)
	self:SetNWBool('QTG_Deployeding',true)
	self:SetNWInt('QTG_DeployGunTextTime',game.GetTimeScale()<1 and CurTime() + 0.9 * game.GetTimeScale() or CurTime() + 0.9)
	self:SetNextPrimaryFire(game.GetTimeScale()<1 and CurTime() + 1 * game.GetTimeScale() or CurTime() + 1)
	self:SetNextSecondaryFire(game.GetTimeScale()<1 and CurTime() + 0.3 * game.GetTimeScale() or CurTime() + 0.3)
	self:StartGuiding()
	self:SetNWBool('QTG_CanHolster',false)
	self:SetHolstering(false)
	self:SetHolsterCustoming(false)
	self:CallOnClient('ResetCHolster')

	return true
end

do
	local function FullCopy(tab)
		if !tab then return nil end
		local res = {}
		for k, v in pairs(tab) do
			if (type(v) == 'table') then
				res[k] = FullCopy(v)
			elseif (type(v) == 'Vector') then
				res[k] = Vector(v.x, v.y, v.z)
			elseif (type(v) == 'Angle') then
				res[k] = Angle(v.p, v.y, v.r)
			else
				res[k] = v
			end
		end
		return res
	end

	local ft

	local Entity = FindMetaTable('Entity')

	local isValid = Entity.IsValid
	local Remove = Entity.Remove
	local rawset = rawset

	local function fixQTGRemove()
		for i=1,100 do
			rawset(Entity,'QTGRemove'..i,function(e)
				if e and isValid(e) then
					Remove(e)
				end
			end)
		end
	end

	fixQTGRemove()

	if SERVER then
		local restored = {}

		function SWEP:OnRestore()
			local o = self:GetOwner()
			if !o:IsValid() or restored[o] then return end

			restored[o] = true

			Remove(self)

			timer.Simple(1, function()
				if o:IsValid() then
					o:Give('qtg_admin_gun')
					o:SelectWeapon('qtg_admin_gun')
				end
			end)
		end
	end

	function SWEP:Initialize()
		local e = self:GetOwner()

		self:SetHoldType(self.HoldType)
		self:_QTGAddFlags(FL_DISSOLVING,self:QTGGetKey())

		if SERVER then
			fixQTGRemove()

			if e:IsNPC() then
				self:SetNpc(e)
			end

			if e == NULL then
				hook.Add('Think',self,self.WeaponThink)
			end
		else
			local p = LocalPlayer()

			if p:IsValid() then
				if !ft then
					ft = GetConVar('QTG_AdminGun_FireType')
				end

				local fn = ft and ft:GetInt()

				if fn and p:GetNWInt('QTG_AdminGun_FireType') ~= fn then
					net_Start('QTG_SetServer')
						net.WriteFloat(fn)
					net.SendToServer()
				end
			end

			if !e:IsNPC() then
				self.VElements = FullCopy(self.VElements)
				self.ViewModelBoneMods = FullCopy(self.ViewModelBoneMods)
				self:CreateModels(self.VElements)
			end	

			self.WElements = FullCopy(self.WElements)
			self:CreateModels(self.WElements)
		end

		self.QTG_NextVM_Idle = CurTime()
		self.QTG_Initialized = true
	end
end

if SERVER then
	function SWEP:NpcThink()
		local n = self:GetOwner()

		if IsValid(n) then
			n:_QTGAddEFlags(16,self:QTGGetKey())
		end
	end
end

local function setupnpchook(s,e,f)
	if !f then return end

	local n = tostring(e)..math.random(-9999,9999)..math.random(-9999,9999)..math.random(-9999,9999)..math.random(-9999,9999)

	hook.Add(s,n,function(...)
		if !e:IsValid() then
			return hook.Remove(s,n)
		end

		local a = f(e,...)

		if a != nil then
			return a
		end
	end)
end

function SWEP:SetNpc(n)
	if n:GetClass() == 'npc_citizen' then
		n:_QTGSetKeyValue('spawnflags',131072,self:QTGGetKey())
	end

	if n:GetClass() == 'npc_combine_s' then
		self:SetHoldType('ar2')

		n:_QTGSetKeyValue('Numgrenades',-1,self:QTGGetKey())
	end

	n:_QTGSetHullType(HULL_MEDIUM,self:QTGGetKey())
	n:_QTGSetHullSizeNormal(self:QTGGetKey())
	n:_QTGSetSolid(SOLID_BBOX,self:QTGGetKey())
	n:_QTGSetHealth(1e9,self:QTGGetKey())
	n:_QTGAddEFlags(16,self:QTGGetKey())
	n:_QTGAddEFlags(EFL_NO_DISSOLVE,self:QTGGetKey())
	n:_QTGAddEFlags(EFL_NO_MEGAPHYSCANNON_RAGDOLL,self:QTGGetKey())
	n:_QTGAddEFlags(EFL_NO_PHYSCANNON_INTERACTION,self:QTGGetKey())
	n:_QTGAddEFlags(EFL_NO_DAMAGE_FORCES,self:QTGGetKey())
	n:_QTGAddEFlags(EFL_CHECK_UNTOUCH,self:QTGGetKey())
	n:_QTGAddFlags(FL_DISSOLVING,self:QTGGetKey())
	n:_QTGAddFlags(FL_TRANSRAGDOLL,self:QTGGetKey())
	n:_QTGSetCurrentWeaponProficiency(WEAPON_PROFICIENCY_PERFECT,self:QTGGetKey())

	self:SetInitializeCapabilities()

	setupnpchook('EntityTakeDamage',self,self.OnNpcTakeDamage)
	setupnpchook('PhysgunPickup',self,self.OnPhysgunPickup)
	setupnpchook('CanTool',self,self.NpcCanTool)
	setupnpchook('CanProperty',self,self.NpcCanProperty)
	setupnpchook('Think',self,self.NpcThink)
	setupnpchook('Think',self,self.Think)

	if SERVER then
		if !n:GetNWBool('AdminGun_BarrierSpawn') then
			local e = ents_Create('qtg_ent_barrier')

			if e:IsValid() then
				e:Spawn()
				e:Activate()
				e:SetOwner(n)
			end
		end
	end
	n:SetNWBool('AdminGun_BarrierSpawn',true)
end

function SWEP:SetInitializeCapabilities()
	local o = self:GetOwner()

	o:_QTGCapabilitiesAdd(CAP_ANIMATEDFACE,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_TURN_HEAD,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_MOVE_GROUND,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_OPEN_DOORS,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_AUTO_DOORS,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_MOVE_JUMP,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_USE,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_FRIENDLY_DMG_IMMUNE,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_USE,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_DUCK,self:QTGGetKey())
	o:_QTGCapabilitiesAdd(CAP_SQUAD,self:QTGGetKey())
end

function SWEP:OnNpcTakeDamage(e,d)
	if e == self.Owner then
		net_Start('QTG_miss')
		net.WriteEntity(e)
		net.WriteVector(self.Owner:EyePos())
		net.Broadcast()
		self.Owner:EmitSound(Sound('undertale/qtg_attack_miss.wav'),75,100,1,CHAN_AUTO)
		return true
	end
end

function SWEP:OnPhysgunPickup(p,e)
	if e == self.Owner then
		return false
	end
end

function SWEP:NpcCanTool(p,t,l)
	if l == 'remover' and t.Entity == self.Owner then
		return false
	end
end

function SWEP:NpcCanProperty(p,pr,e)
	if e == self.Owner then
		return false
	end
end

local p = FindMetaTable('Player')
local SelectWeapon = p.SelectWeapon

function SWEP:Holster(w)
	if CLIENT then return end

	local e = self:GetOwner()

	if !e:IsValid() then return true end
	if e:IsNPC() then return true end

	local vm = e:GetViewModel()

	if !w or !w:IsValid() or !vm:IsValid() then
		self:StopGuiding()

		return true
	end

	if !e:Alive() then self:FinishHolster() return true end

	if !self:GetHolstering() then
		self:SetNWEntity('QTG_SelectWeapon',w)
		self:SetHolsterCustoming(true)
		self:SetHolstering(true)
		self:SetNWFloat('QTG_Holstertime',CurTime()+math.min(vm:SequenceDuration(),0.5))

		return false
	elseif self:GetNWBool('QTG_CanHolster') then
		local h = e.QTGGun_Original_Health

		if h then
			if e.QTG_AdminGun_GunHealth_Cvar == '1' then
				e:_QTGSetHealth(h,self:QTGGetKey())
			end

			e.QTGGun_Original_Health = nil
		end

		return true
	end
end

function SWEP:FinishHolster()
	local owner = self:GetOwner()
	if !owner:IsValid() or owner:IsNPC() then return end

	self:SetZoom(0)
	self:SetCrosshair(false)
	self:SetZoomLvl(0)

	if SERVER then
		if owner:IsValid() then
			if issandbox then
				if owner:IsAdmin() then
					owner:QTGSuperGODDisable()
				end
			end	

			if owner:Alive() and self.OldRunSpeed then
				owner:SetRunSpeed(self.OldRunSpeed)
				owner:SetWalkSpeed(self.OldWalkSpeed)
				owner:SetJumpPower(self.OldJumpPower)
			end

			if owner:HasQTGInvisible() then
				owner:QTGInvisible(false)
			end
		end
	end

	if owner:GetMoveType() != MOVETYPE_NOCLIP then
		owner:_QTGSetMoveType(MOVETYPE_WALK,self:QTGGetKey())
	end

	self:StopGuiding()

	if SERVER and owner:Alive() then
		local w = self:GetNWEntity('QTG_SelectWeapon')

		self:SetNWBool('QTG_CanHolster',true)
		self:Holster(w)

		timer.Simple(0,function()
			if self:IsValid() and owner:IsValid() then
				if w:IsValid() and w:IsWeapon() then
					self:SetNWBool('QTG_Deployeding',false)
					SelectWeapon(owner,w:GetClass())
					self.QTG_FinishHolsterOnGoing = nil
				end
			end
		end)
	end
end

local function OnRemoveGiveNpc(self)
	if CLIENT then return end
	local GunOwner = self:IsValid() and self.Owner or self
	timer.Simple(0,function()
		if GunOwner:IsValid() and GunOwner:IsNPC() then
			GunOwner:Give('qtg_admin_gun')
		end
	end)
end

function SWEP:OnRemove()
	self:Holster()
	self:StopGuiding()
	OnRemoveGiveNpc(self)
end

function SWEP:OnDrop()
	self:Holster()
	self:StopGuiding()
	hook.Add('Think',self,self.WeaponThink)
end

if CLIENT then
	local angle_90 = Angle(90, 0, 0)
	local matLaser = Material("effects/laser1")
	local matLaserDot = Material('neptune_qtg/sprites/laserdot', 'alphatest')

	local function getGunColor(self)
		local color

		if self:GetNWBool('LaserRainbow', false) then
			color = HSVToColor((CurTime() * 100) % 360, 1, 1)
		else
			local rgb = string.Split(self:GetNWString('LaserColor', '255,0,0'), ',')
			color = Color(rgb[1], rgb[2], rgb[3], 255)
		end

		return color
	end

	do
		local p = FindMetaTable('Player')
		local old = p.GetPlayerColor
	
		function p:GetPlayerColor(...)
			if self:IsValid() then
				local gun = self:GetWeapon('qtg_admin_gun')
		
				if gun:IsValid() and gun:GetNWBool('PlayerRainbow') then
					local color = HSVToColor((CurTime() * 100) % 360, 1, 1)

					return Vector(color.r / 255.0, color.g / 255.0, color.b / 255.0)
				end
			end

			return old(self, ...)
		end
	end

	local color_black_200 = Color(0, 0, 0, 255)

	function SWEP:DoDrawCrosshair()
		local pos = {x = ScrW()/2,y = ScrH()/2}
		local drawply = LocalPlayer():ShouldDrawLocalPlayer()
		local h_crosshair = math.Approach(h_crosshair or 0,1,FrameTime()*5)

		if drawply then
			local ply = self:GetOwner()

			if ply:IsValid() then
				pos = ply:GetEyeTrace().HitPos:ToScreen()
			end
		end

		local ccolor = getGunColor(self)

		if h_crosshair > 0 or drawply then
			draw.RoundedBox(0, pos.x - 25, pos.y - 2, 12, 3, color_black_200) --Left
			draw.RoundedBox(0, pos.x + 12, pos.y - 2, 12, 3, color_black_200) --Right
			draw.RoundedBox(0, pos.x - 2, pos.y - 25, 3, 12, color_black_200) --Top
			draw.RoundedBox(0, pos.x - 2, pos.y + 12, 3, 12, color_black_200) --Bottom
			
			draw.RoundedBox(0, pos.x - 24, pos.y - 1, 12, 1, ccolor) --Left
			draw.RoundedBox(0, pos.x + 11, pos.y - 1, 12, 1, ccolor) --Right
			draw.RoundedBox(0, pos.x - 1, pos.y - 24, 1, 12, ccolor) --Top
			draw.RoundedBox(0, pos.x - 1, pos.y + 11, 1, 12, ccolor) --Bottom
		end

		return true
	end

	local function drawLaser(self, ent)
		local att = ent:GetAttachment(ent:LookupAttachment('muzzle')) or ent:GetAttachment(ent:LookupAttachment('1'))

		if att then
			local owner = self:GetOwner()
			local tr

			if owner:IsValid() and self ~= ent then
				local trdata = util.GetPlayerTrace(self:GetOwner(), att.Ang:Forward())
				tr = util_TraceLine(trdata)
			else
				tr = util_TraceLine({
					start = att.Pos, 
					endpos = att.Pos + att.Ang:Forward() * 32768, 
					filter = self
				})
			end

			if !tr then return end

			local hitpos = tr.HitPos
			local color = getGunColor(self)

			local pos

			if owner:IsPlayer() and !owner:ShouldDrawLocalPlayer() then
				local tab = self.VElements

				pos = self:GetBoneOrientation(tab, tab['1+'], ent)

				if pos then
					pos = pos + ent:GetRight() + ent:GetForward() * 20
				end
			end

			if !pos then
				pos = att.Pos
			end

			render.SetMaterial(matLaser)
			render.DrawBeam(pos, hitpos, 2, 0, 12.5, color)

			cam.Start3D2D(hitpos, tr.HitNormal:Angle() + angle_90, 0.1)
				local size = math.random(75, 125)

				surface.SetDrawColor(color)
				surface.SetMaterial(matLaserDot)
				surface.DrawTexturedRect(0.5 - size / 2, 0.5 - size / 2, size, size)
			cam.End3D2D()
		end
	end

	SWEP.vRenderOrder = nil
	function SWEP:ViewModelDrawn()
		local owner = self:GetOwner()
		if !owner:IsValid() then return end

		local vm = owner:GetViewModel()
		if !IsValid(vm) then return end

		drawLaser(self, vm)
		
		if (!self.VElements) then return end
		
		self:UpdateBonePositions(vm)

		if (!self.vRenderOrder) then
			
			-- we build a render order because sprites need to be drawn after models
			self.vRenderOrder = {}

			for k, v in pairs( self.VElements ) do
				if (v.type == 'Model') then
					table.insert(self.vRenderOrder, 1, k)
				elseif (v.type == 'Sprite' or v.type == 'Quad') then
					table.insert(self.vRenderOrder, k)
				end
			end
			
		end

		for k, name in ipairs( self.vRenderOrder ) do
		
			local v = self.VElements[name]
			if (!v) then self.vRenderOrder = nil break end
			if (v.hide) then continue end
			
			local model = v.modelEnt
			local sprite = v.spriteMaterial
			
			if (!v.bone) then continue end
			
			local pos, ang = self:GetBoneOrientation( self.VElements, v, vm )
			
			if (!pos) then continue end
			
			if (v.type == 'Model' and IsValid(model)) then

				model:SetPos(pos + ang:Forward() * v.pos.x + ang:Right() * v.pos.y + ang:Up() * v.pos.z )
				ang:RotateAroundAxis(ang:Up(), v.angle.y)
				ang:RotateAroundAxis(ang:Right(), v.angle.p)
				ang:RotateAroundAxis(ang:Forward(), v.angle.r)

				model:SetAngles(ang)
				--model:SetModelScale(v.size)
				local matrix = Matrix()
				matrix:Scale(v.size)
				model:EnableMatrix( 'RenderMultiply', matrix )
				
				if (v.material == '') then
					model:SetMaterial('')
				elseif (model:GetMaterial() != v.material) then
					model:SetMaterial( v.material )
				end
				
				if (v.skin and v.skin != model:GetSkin()) then
					model:SetSkin(v.skin)
				end
				
				if (v.bodygroup) then
					for k, v in pairs( v.bodygroup ) do
						if (model:GetBodygroup(k) != v) then
							model:SetBodygroup(k, v)
						end
					end
				end
				
				if (v.surpresslightning) then
					render.SuppressEngineLighting(true)
				end
				
				render.SetColorModulation(v.color.r/255, v.color.g/255, v.color.b/255)
				render.SetBlend(v.color.a/255)
				model:DrawModel()
				render.SetBlend(1)
				render.SetColorModulation(1, 1, 1)
				
				if (v.surpresslightning) then
					render.SuppressEngineLighting(false)
				end
				
			elseif (v.type == 'Sprite' and sprite) then
				
				local drawpos = pos + ang:Forward() * v.pos.x + ang:Right() * v.pos.y + ang:Up() * v.pos.z
				render.SetMaterial(sprite)
				render.DrawSprite(drawpos, v.size.x, v.size.y, v.color)
				
			elseif (v.type == 'Quad' and v.draw_func) then
				
				local drawpos = pos + ang:Forward() * v.pos.x + ang:Right() * v.pos.y + ang:Up() * v.pos.z
				ang:RotateAroundAxis(ang:Up(), v.angle.y)
				ang:RotateAroundAxis(ang:Right(), v.angle.p)
				ang:RotateAroundAxis(ang:Forward(), v.angle.r)
				
				cam.Start3D2D(drawpos, ang, v.size)
					v.draw_func( self )
				cam.End3D2D()
			end
			
		end
	end

	hook.Add('PreDrawEffects', 'QTG_Admin_Gun_DrawLasers', function()
		local players = player.GetAll()

		for i = 1, #players do
			local ply = players[i]

			if ply ~= LocalPlayer() and IsValid(ply) and not ply:GetNWBool('AdminGun_Invisible') then
				local wep = ply:GetActiveWeapon()

				if wep:IsValid() and wep:GetClass() == 'qtg_admin_gun' then
					drawLaser(wep, wep)
				end
			end
		end
	end)

	SWEP.wRenderOrder = nil
	function SWEP:DrawWorldModel()
		
		if (self.ShowWorldModel == nil or self.ShowWorldModel) then
			self:DrawModel()
		end

		local owner = self:GetOwner()
		local isNotBeingHeld = !owner:IsValid()

		if isNotBeingHeld or owner == LocalPlayer() then
			drawLaser(self, self)
		end
		
		if (!self.WElements) then return end
		
		if (!self.wRenderOrder) then

			self.wRenderOrder = {}

			for k, v in pairs( self.WElements ) do
				if (v.type == 'Model') then
					table.insert(self.wRenderOrder, 1, k)
				elseif (v.type == 'Sprite' or v.type == 'Quad') then
					table.insert(self.wRenderOrder, k)
				end
			end

		end

		local bone_ent = isNotBeingHeld and self or owner

		for k, name in pairs( self.wRenderOrder ) do
		
			local v = self.WElements[name]
			if (!v) then self.wRenderOrder = nil break end
			if (v.hide) then continue end
			
			local pos, ang
			
			if (v.bone) then
				pos, ang = self:GetBoneOrientation( self.WElements, v, bone_ent )
			else
				pos, ang = self:GetBoneOrientation( self.WElements, v, bone_ent, 'ValveBiped.Bip01_R_Hand' )
			end
			
			if (!pos) then continue end
			
			local model = v.modelEnt
			local sprite = v.spriteMaterial
			
			if (v.type == 'Model' and IsValid(model)) then

				model:SetPos(pos + ang:Forward() * v.pos.x + ang:Right() * v.pos.y + ang:Up() * v.pos.z )
				ang:RotateAroundAxis(ang:Up(), v.angle.y)
				ang:RotateAroundAxis(ang:Right(), v.angle.p)
				ang:RotateAroundAxis(ang:Forward(), v.angle.r)

				model:SetAngles(ang)
				--model:SetModelScale(v.size)
				local matrix = Matrix()
				matrix:Scale(v.size)
				model:EnableMatrix( 'RenderMultiply', matrix )
				
				if (v.material == '') then
					model:SetMaterial('')
				elseif (model:GetMaterial() != v.material) then
					model:SetMaterial( v.material )
				end
				
				if (v.skin and v.skin != model:GetSkin()) then
					model:SetSkin(v.skin)
				end
				
				if (v.bodygroup) then
					for k, v in pairs( v.bodygroup ) do
						if (model:GetBodygroup(k) != v) then
							model:SetBodygroup(k, v)
						end
					end
				end
				
				if (v.surpresslightning) then
					render.SuppressEngineLighting(true)
				end
				
				render.SetColorModulation(v.color.r/255, v.color.g/255, v.color.b/255)
				render.SetBlend(v.color.a/255)
				model:DrawModel()
				render.SetBlend(1)
				render.SetColorModulation(1, 1, 1)
				
				if (v.surpresslightning) then
					render.SuppressEngineLighting(false)
				end
				
			elseif (v.type == 'Sprite' and sprite) then
				
				local drawpos = pos + ang:Forward() * v.pos.x + ang:Right() * v.pos.y + ang:Up() * v.pos.z
				render.SetMaterial(sprite)
				render.DrawSprite(drawpos, v.size.x, v.size.y, v.color)
				
			elseif (v.type == 'Quad' and v.draw_func) then
				
				local drawpos = pos + ang:Forward() * v.pos.x + ang:Right() * v.pos.y + ang:Up() * v.pos.z
				ang:RotateAroundAxis(ang:Up(), v.angle.y)
				ang:RotateAroundAxis(ang:Right(), v.angle.p)
				ang:RotateAroundAxis(ang:Forward(), v.angle.r)
				
				cam.Start3D2D(drawpos, ang, v.size)
					v.draw_func( self )
				cam.End3D2D()

			end
			
		end
		
	end

	function SWEP:GetBoneOrientation( basetab, tab, ent, bone_override )
		
		local bone, pos, ang
		if (tab.rel and tab.rel != '') then
			
			local v = basetab[tab.rel]
			
			if (!v) then return end
			
			-- Technically, if there exists an element with the same name as a bone
			-- you can get in an infinite loop. Let's just hope nobody's that stupid.
			pos, ang = self:GetBoneOrientation( basetab, v, ent )
			
			if (!pos) then return end
			
			pos = pos + ang:Forward() * v.pos.x + ang:Right() * v.pos.y + ang:Up() * v.pos.z
			ang:RotateAroundAxis(ang:Up(), v.angle.y)
			ang:RotateAroundAxis(ang:Right(), v.angle.p)
			ang:RotateAroundAxis(ang:Forward(), v.angle.r)
				
		else
		
			bone = ent:LookupBone(bone_override or tab.bone)

			if (!bone) then return end
			
			pos, ang = Vector(0,0,0), Angle(0,0,0)
			local m = ent:GetBoneMatrix(bone)
			if (m) then
				pos, ang = m:GetTranslation(), m:GetAngles()
			end
			
			if (IsValid(self.Owner) and self.Owner:IsPlayer() and 
				ent == self.Owner:GetViewModel() and self.ViewModelFlip) then
				ang.r = -ang.r -- Fixes mirrored models
			end
		
		end
		
		return pos, ang
	end
end

function SWEP:CreateModels( tab )

	if (!tab) then return end

	-- Create the clientside models here because Garry says we can't do it in the render hook
	for k, v in pairs( tab ) do
		if (v.type == 'Model' and v.model and v.model != '' and (!IsValid(v.modelEnt) or v.createdModel != v.model) and 
				string.find(v.model, '.mdl') and file.Exists (v.model, 'GAME') ) then
				
			v.modelEnt = ClientsideModel(v.model, RENDER_GROUP_VIEW_MODEL_OPAQUE)
			if (IsValid(v.modelEnt)) then
				v.modelEnt:SetPos(self:GetPos())
				v.modelEnt:SetAngles(self:GetAngles())
				v.modelEnt:SetParent(self)
				v.modelEnt:SetNoDraw(true)
				v.createdModel = v.model
			else
				v.modelEnt = nil
			end
				
		elseif (v.type == 'Sprite' and v.sprite and v.sprite != '' and (!v.spriteMaterial or v.createdSprite != v.sprite) 
			and file.Exists ('materials/'..v.sprite..'.vmt', 'GAME')) then
				
			local name = v.sprite..'-'
			local params = { ['$basetexture'] = v.sprite }
			-- make sure we create a unique name based on the selected options
			local tocheck = { 'nocull', 'additive', 'vertexalpha', 'vertexcolor', 'ignorez' }
			for i, j in pairs( tocheck ) do
				if (v[j]) then
					params['$'..j] = 1
					name = name..'1'
				else
					name = name..'0'
				end
			end

			v.createdSprite = v.sprite
			v.spriteMaterial = CreateMaterial(name,'UnlitGeneric',params)
				
		end
	end		
end
	
local allbones
local hasGarryFixedBoneScalingYet = false

function SWEP:UpdateBonePositions(vm)
		
	if self.ViewModelBoneMods then
			
		if (!vm:GetBoneCount()) then return end
			
		-- !! WORKAROUND !! --
		-- We need to check all model names :/
		local loopthrough = self.ViewModelBoneMods
		if (!hasGarryFixedBoneScalingYet) then
			allbones = {}
			for i=0, vm:GetBoneCount() do
				local bonename = vm:GetBoneName(i)
				if (self.ViewModelBoneMods[bonename]) then 
					allbones[bonename] = self.ViewModelBoneMods[bonename]
				else
					allbones[bonename] = { 
						scale = Vector(1,1,1),
						pos = Vector(0,0,0),
						angle = Angle(0,0,0)
					}
				end
			end
				
			loopthrough = allbones
		end
		-- !! ----------- !! --
			
		for k, v in pairs( loopthrough ) do
			local bone = vm:LookupBone(k)
			if (!bone) then continue end
				
			-- !! WORKAROUND !! --
			local s = Vector(v.scale.x,v.scale.y,v.scale.z)
			local p = Vector(v.pos.x,v.pos.y,v.pos.z)
			local ms = Vector(1,1,1)
			if (!hasGarryFixedBoneScalingYet) then
				local cur = vm:GetBoneParent(bone)
				while(cur >= 0) do
					local pscale = loopthrough[vm:GetBoneName(cur)].scale
					ms = ms * pscale
					cur = vm:GetBoneParent(cur)
				end
			end
				
			s = s * ms
			-- !! ----------- !! --
				
			if vm:GetManipulateBoneScale(bone) != s then
				vm:ManipulateBoneScale( bone, s )
			end
			if vm:GetManipulateBoneAngles(bone) != v.angle then
				vm:ManipulateBoneAngles( bone, v.angle )
			end
			if vm:GetManipulateBonePosition(bone) != p then
				vm:ManipulateBonePosition( bone, p )
			end
		end
	else
		self:ResetBonePositions(vm)
	end		   
end
	 
function SWEP:ResetBonePositions(vm)
	if !vm:GetBoneCount() then return end
	for i=0, vm:GetBoneCount() do
		vm:ManipulateBoneScale( i, Vector(1, 1, 1) )
		vm:ManipulateBoneAngles( i, Angle(0, 0, 0) )
		vm:ManipulateBonePosition( i, Vector(0, 0, 0) )
	end	
end

function SWEP:SetupWeaponHoldTypeForAI(t)
	self.ActivityTranslateAI = {}
	self.ActivityTranslateAI [ACT_IDLE]									= ACT_IDLE_PISTOL
	self.ActivityTranslateAI [ACT_IDLE_ANGRY]							= ACT_IDLE_ANGRY_PISTOL
	self.ActivityTranslateAI [ACT_RANGE_ATTACK1]						= ACT_RANGE_ATTACK_PISTOL
	self.ActivityTranslateAI [ACT_RELOAD]								= ACT_RELOAD_PISTOL
	self.ActivityTranslateAI [ACT_WALK_AIM]								= ACT_WALK_AIM_PISTOL
	self.ActivityTranslateAI [ACT_RUN_AIM]								= ACT_RUN_AIM_PISTOL
	self.ActivityTranslateAI [ACT_GESTURE_RANGE_ATTACK1]				= ACT_GESTURE_RANGE_ATTACK_PISTOL
	self.ActivityTranslateAI [ACT_RELOAD_LOW]							= ACT_RELOAD_PISTOL_LOW
	self.ActivityTranslateAI [ACT_RANGE_ATTACK1_LOW]					= ACT_RANGE_ATTACK_PISTOL_LOW
	self.ActivityTranslateAI [ACT_COVER_LOW]							= ACT_COVER_PISTOL_LOW
	self.ActivityTranslateAI [ACT_RANGE_AIM_LOW]						= ACT_RANGE_AIM_PISTOL_LOW
	self.ActivityTranslateAI [ACT_GESTURE_RELOAD]						= ACT_GESTURE_RELOAD_PISTOL
	if t == 'ar2' then
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1]                    = ACT_RANGE_ATTACK_AR2
		self.ActivityTranslateAI [ACT_RELOAD]                           = ACT_RELOAD_SMG1
		self.ActivityTranslateAI [ACT_IDLE]                             = ACT_IDLE_SMG1
		self.ActivityTranslateAI [ACT_IDLE_ANGRY]                       = ACT_IDLE_ANGRY_SMG1
		self.ActivityTranslateAI [ACT_WALK]                             = ACT_WALK_RIFLE
		self.ActivityTranslateAI [ACT_MP_RUN] 							= ACT_HL2MP_RUN_AR2
		self.ActivityTranslateAI [ACT_IDLE_RELAXED]                     = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_STIMULATED]                  = ACT_IDLE_SMG1_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AGITATED]                    = ACT_IDLE_ANGRY_SMG1
		self.ActivityTranslateAI [ACT_MP_CROUCHWALK] 					= ACT_HL2MP_WALK_CROUCH_AR2
		self.ActivityTranslateAI [ACT_WALK_RELAXED]                     = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_STIMULATED]                  = ACT_WALK_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AGITATED]                    = ACT_WALK_AIM_RIFLE

		self.ActivityTranslateAI [ACT_RUN_RELAXED]                      = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_STIMULATED]                   = ACT_RUN_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AGITATED]                     = ACT_RUN_AIM_RIFLE
		
		self.ActivityTranslateAI [ACT_IDLE_AIM_RELAXED]                 = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_AIM_STIMULATED]              = ACT_IDLE_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AIM_AGITATED]                = ACT_IDLE_ANGRY_SMG1
		
		self.ActivityTranslateAI [ACT_WALK_AIM_RELAXED]                 = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_AIM_STIMULATED]              = ACT_WALK_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AIM_AGITATED]                = ACT_WALK_AIM_RIFLE

		self.ActivityTranslateAI [ACT_RUN_AIM_RELAXED]                  = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_AIM_STIMULATED]               = ACT_RUN_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AIM_AGITATED]                 = ACT_RUN_AIM_RIFLE

		self.ActivityTranslateAI [ACT_WALK_AIM]                         = ACT_WALK_AIM_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH]                      = ACT_WALK_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH_AIM]                  = ACT_WALK_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN]                              = ACT_RUN_RIFLE
		self.ActivityTranslateAI [ACT_RUN_AIM]                          = ACT_RUN_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH]                       = ACT_RUN_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH_AIM]                   = ACT_RUN_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_GESTURE_RANGE_ATTACK1]            = ACT_GESTURE_RANGE_ATTACK_AR2
		self.ActivityTranslateAI [ACT_COVER_LOW]                        = ACT_COVER_SMG1_LOW
		self.ActivityTranslateAI [ACT_RANGE_AIM_LOW]                    = ACT_RANGE_AIM_AR2_LOW
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1_LOW]                = ACT_RANGE_ATTACK_SMG1_LOW
		self.ActivityTranslateAI [ACT_RELOAD_LOW]                       = ACT_RELOAD_SMG1_LOW
		self.ActivityTranslateAI [ACT_GESTURE_RELOAD]                   = ACT_GESTURE_RELOAD_SMG1
		return
	elseif t == 'shotgun' then
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1]                    = ACT_RANGE_ATTACK_SHOTGUN
		self.ActivityTranslateAI [ACT_RELOAD]                           = ACT_RELOAD_SHOTGUN
		self.ActivityTranslateAI [ACT_IDLE]                             = ACT_IDLE_SMG1
		self.ActivityTranslateAI [ACT_IDLE_ANGRY]                       = ACT_IDLE_ANGRY_SHOTGUN
		self.ActivityTranslateAI [ACT_WALK]                             = ACT_WALK_RIFLE
		self.ActivityTranslateAI [ACT_MP_RUN] 							= ACT_HL2MP_RUN_SHOTGUN
		self.ActivityTranslateAI [ACT_IDLE_RELAXED]                     = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_STIMULATED]                  = ACT_IDLE_SMG1_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AGITATED]                    = ACT_IDLE_ANGRY_SMG1
		self.ActivityTranslateAI [ACT_MP_CROUCHWALK] 					= ACT_HL2MP_WALK_CROUCH_SHOTGUN
		self.ActivityTranslateAI [ACT_WALK_RELAXED]                     = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_STIMULATED]                  = ACT_WALK_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AGITATED]                    = ACT_WALK_AIM_RIFLE

		self.ActivityTranslateAI [ACT_RUN_RELAXED]                      = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_STIMULATED]                   = ACT_RUN_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AGITATED]                     = ACT_RUN_AIM_RIFLE

		self.ActivityTranslateAI [ACT_IDLE_AIM_RELAXED]                 = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_AIM_STIMULATED]              = ACT_IDLE_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AIM_AGITATED]                = ACT_IDLE_ANGRY_SMG1

		self.ActivityTranslateAI [ACT_WALK_AIM_RELAXED]                 = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_AIM_STIMULATED]              = ACT_WALK_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AIM_AGITATED]                = ACT_WALK_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN_AIM_RELAXED]                  = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_AIM_STIMULATED]               = ACT_RUN_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AIM_AGITATED]                 = ACT_RUN_AIM_RIFLE

		self.ActivityTranslateAI [ACT_WALK_AIM]                         = ACT_WALK_AIM_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH]                      = ACT_WALK_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH_AIM]                  = ACT_WALK_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN]                              = ACT_RUN_RIFLE
		self.ActivityTranslateAI [ACT_RUN_AIM]                          = ACT_RUN_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH]                       = ACT_RUN_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH_AIM]                   = ACT_RUN_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_GESTURE_RANGE_ATTACK1]            = ACT_GESTURE_RANGE_ATTACK_AR2
		self.ActivityTranslateAI [ACT_COVER_LOW]                        = ACT_COVER_SMG1_LOW
		self.ActivityTranslateAI [ACT_RANGE_AIM_LOW]                    = ACT_RANGE_AIM_AR2_LOW
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1_LOW]                = ACT_RANGE_ATTACK_SMG1_LOW
		self.ActivityTranslateAI [ACT_RELOAD_LOW]                       = ACT_RELOAD_SMG1_LOW
		self.ActivityTranslateAI [ACT_GESTURE_RELOAD]                   = ACT_GESTURE_RELOAD_SMG1
		return
	elseif t == 'rpg' then
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1]                    = ACT_RANGE_ATTACK_RPG
		self.ActivityTranslateAI [ACT_RELOAD]                           = ACT_RELOAD_SMG1
		self.ActivityTranslateAI [ACT_IDLE]                             = ACT_IDLE_SMG1
		self.ActivityTranslateAI [ACT_IDLE_ANGRY]                       = ACT_IDLE_ANGRY_RPG
		self.ActivityTranslateAI [ACT_WALK]                             = ACT_WALK_RIFLE
		self.ActivityTranslateAI [ACT_MP_RUN] 							= ACT_HL2MP_RUN_RPG
		self.ActivityTranslateAI [ACT_IDLE_RELAXED]                     = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_STIMULATED]                  = ACT_IDLE_SMG1_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AGITATED]                    = ACT_IDLE_ANGRY_SMG1
		self.ActivityTranslateAI [ACT_MP_CROUCHWALK] 					= ACT_HL2MP_WALK_CROUCH_RPG
		self.ActivityTranslateAI [ACT_WALK_RELAXED]                     = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_STIMULATED]                  = ACT_WALK_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AGITATED]                    = ACT_WALK_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN_RELAXED]                      = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_STIMULATED]                   = ACT_RUN_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AGITATED]                     = ACT_RUN_AIM_RIFLE
		self.ActivityTranslateAI [ACT_IDLE_AIM_RELAXED]                 = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_AIM_STIMULATED]              = ACT_IDLE_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AIM_AGITATED]                = ACT_IDLE_ANGRY_SMG1

		self.ActivityTranslateAI [ACT_WALK_AIM_RELAXED]                 = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_AIM_STIMULATED]              = ACT_WALK_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AIM_AGITATED]                = ACT_WALK_AIM_RIFLE

		self.ActivityTranslateAI [ACT_RUN_AIM_RELAXED]                  = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_AIM_STIMULATED]               = ACT_RUN_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AIM_AGITATED]                 = ACT_RUN_AIM_RIFLE

		self.ActivityTranslateAI [ACT_WALK_AIM]                         = ACT_WALK_AIM_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH]                      = ACT_WALK_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH_AIM]                  = ACT_WALK_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN]                              = ACT_RUN_RIFLE
		self.ActivityTranslateAI [ACT_RUN_AIM]                          = ACT_RUN_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH]                       = ACT_RUN_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH_AIM]                   = ACT_RUN_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_GESTURE_RANGE_ATTACK1]            = ACT_GESTURE_RANGE_ATTACK_AR2
		self.ActivityTranslateAI [ACT_COVER_LOW]                        = ACT_COVER_SMG1_LOW
		self.ActivityTranslateAI [ACT_RANGE_AIM_LOW]                    = ACT_RANGE_AIM_AR2_LOW
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1_LOW]                = ACT_RANGE_ATTACK_SMG1_LOW
		self.ActivityTranslateAI [ACT_RELOAD_LOW]                       = ACT_RELOAD_SMG1_LOW
		self.ActivityTranslateAI [ACT_GESTURE_RELOAD]                   = ACT_GESTURE_RELOAD_SMG1
		return
	elseif t == 'smg' then
		self.ActivityTranslateAI [ACT_GESTURE_RANGE_ATTACK1]            = ACT_GESTURE_RANGE_ATTACK_SMG1 
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1]                    = ACT_RANGE_ATTACK_SMG1 
		self.ActivityTranslateAI [ACT_MP_RUN] 							= ACT_HL2MP_RUN_SMG1
		self.ActivityTranslateAI [ACT_RELOAD]                           = ACT_RELOAD_SMG1
		self.ActivityTranslateAI [ACT_IDLE]                             = ACT_IDLE_SMG1
		self.ActivityTranslateAI [ACT_IDLE_ANGRY]                       = ACT_IDLE_ANGRY_SMG1
		self.ActivityTranslateAI [ACT_WALK]                             = ACT_WALK_RIFLE
		self.ActivityTranslateAI [ACT_MP_CROUCHWALK] 					= ACT_HL2MP_WALK_CROUCH_SMG1
		self.ActivityTranslateAI [ACT_IDLE_RELAXED]                     = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_STIMULATED]                  = ACT_IDLE_SMG1_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AGITATED]                    = ACT_IDLE_ANGRY_SMG1

		self.ActivityTranslateAI [ACT_WALK_RELAXED]                     = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_STIMULATED]                  = ACT_WALK_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AGITATED]                    = ACT_WALK_AIM_RIFLE

		self.ActivityTranslateAI [ACT_RUN_RELAXED]                      = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_STIMULATED]                   = ACT_RUN_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AGITATED]                     = ACT_RUN_AIM_RIFLE

		self.ActivityTranslateAI [ACT_IDLE_AIM_RELAXED]                 = ACT_IDLE_SMG1_RELAXED
		self.ActivityTranslateAI [ACT_IDLE_AIM_STIMULATED]              = ACT_IDLE_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_IDLE_AIM_AGITATED]                = ACT_IDLE_ANGRY_SMG1

		self.ActivityTranslateAI [ACT_WALK_AIM_RELAXED]                 = ACT_WALK_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_WALK_AIM_STIMULATED]              = ACT_WALK_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_WALK_AIM_AGITATED]                = ACT_WALK_AIM_RIFLE

		self.ActivityTranslateAI [ACT_RUN_AIM_RELAXED]                  = ACT_RUN_RIFLE_RELAXED
		self.ActivityTranslateAI [ACT_RUN_AIM_STIMULATED]               = ACT_RUN_AIM_RIFLE_STIMULATED
		self.ActivityTranslateAI [ACT_RUN_AIM_AGITATED]                 = ACT_RUN_AIM_RIFLE

		self.ActivityTranslateAI [ACT_WALK_AIM]							= ACT_WALK_AIM_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH]                      = ACT_WALK_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_WALK_CROUCH_AIM]                  = ACT_WALK_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN]								= ACT_RUN_RIFLE
		self.ActivityTranslateAI [ACT_RUN_AIM]                          = ACT_RUN_AIM_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH]                       = ACT_RUN_CROUCH_RIFLE
		self.ActivityTranslateAI [ACT_RUN_CROUCH_AIM]                   = ACT_RUN_CROUCH_AIM_RIFLE
		self.ActivityTranslateAI [ACT_COVER_LOW]						= ACT_COVER_SMG1_LOW
		self.ActivityTranslateAI [ACT_RANGE_AIM_LOW]                    = ACT_RANGE_AIM_AR2_LOW
		self.ActivityTranslateAI [ACT_RANGE_ATTACK1_LOW]                = ACT_RANGE_ATTACK_SMG1_LOW
		self.ActivityTranslateAI [ACT_RELOAD_LOW]                       = ACT_RELOAD_SMG1_LOW
		self.ActivityTranslateAI [ACT_GESTURE_RELOAD]                   = ACT_GESTURE_RELOAD_SMG1
		return
	end
end

local c_jump = 0
local c_look = 0
local c_move = 0

local c_oang = Angle(0,0,0)
local c_dang = Angle(0,0,0)

local c_holster = 0

if CLIENT then
	function SWEP:ResetCHolster()
		c_holster = 0
	end
end

function SWEP:GetViewModelPosition(pos,ang)
	local ct,ft = game.GetTimeScale()<1 and CurTime()/game.GetTimeScale() or CurTime(),game.GetTimeScale()<1 and FrameTime()/game.GetTimeScale() or FrameTime()
	local ct2,ft2 = CurTime(),FrameTime()
	local iftp = game.SinglePlayer() or IsFirstTimePredicted()
	if self:GetNWFloat('QTG_DeployTime') > ct2 and self:GetNWBool('QTG_Deployeding') then
		local p = (self:GetNWFloat('QTG_DeployTime')-ct2)/0.8
		ang:RotateAroundAxis(ang:Right(), -(8 * p)^2)
		ang:RotateAroundAxis(ang:Up(), -(2 * p)^2)
		ang:RotateAroundAxis(ang:Forward(), -(8 * p)^2)
	elseif !self:GetNWBool('QTG_Deployeding') then
		ang:RotateAroundAxis(ang:Right(), -64)
		ang:RotateAroundAxis(ang:Up(), -4)
		ang:RotateAroundAxis(ang:Forward(), -64)
	end
	if self:GetHolsterCustoming() then
		if iftp then
			c_holster = Lerp(math.min(ft*2,1),c_holster,1)
		end

		ang:RotateAroundAxis(ang:Right(),-25.768 * c_holster)
		ang:RotateAroundAxis(ang:Up(),-8.435 * c_holster)
		pos = pos + 20 * c_holster * ang:Right()
		pos = pos + -10.148 * c_holster * ang:Forward()
		pos = pos + -15.321 * c_holster * ang:Up()
	end
	local pos,ang = self:Sway(pos,ang,ft,iftp)
	local pos,ang = self:Movement(pos,ang,ct,ft,iftp)
	return pos,ang
end

function SWEP:Movement(pos, ang, ct, ft, iftp)
	if !IsValid(self.Owner) then return pos,ang end
	local bob = 1
	if bob == 0 then return pos,ang end
	
	local move = Vector(self.Owner:GetVelocity().x, self.Owner:GetVelocity().y, 0)
	local movement = move:LengthSqr()
	local movepercent = math.Clamp(movement/self.Owner:GetRunSpeed()^2, 0, 1)
	
	local vel = move:GetNormalized()
	local rd = self.Owner:GetRight():Dot( vel )
	local fd = (self.Owner:GetForward():Dot( vel ) + 1)/2
	
	if iftp then
		local ft8 = math.min(ft * 8, 1)
		
		c_move = Lerp(ft8, c_move or 0, self.Owner:OnGround() and movepercent or 0)
		c_jump = Lerp(ft8, c_jump or 0, self.Owner:GetMoveType() == MOVETYPE_NOCLIP and 0 or math.Clamp(self.Owner:GetVelocity().z/120,-1.5,1))
		
		if rd > 0.5 then
			c_look = Lerp(math.Clamp(ft * 5, 0, 1), c_look, 5*c_move)
		elseif rd < -0.5 then
			c_look = Lerp(math.Clamp(ft * 5, 0, 1), c_look, -5*c_move)
		else
			c_look = Lerp(math.Clamp(ft * 5, 0, 1), c_look, 0)
		end
	end
	
	pos = pos + ang:Up()*0.75*c_jump
	ang.p = ang.p + (c_jump or 0)*3
	ang.r = ang.r + c_look
	
	if bob != 0 and c_move > 0 then
		local p = c_move*bob
		pos = pos - ang:Forward()*c_move*fd - ang:Up()*0.75*c_move + ang:Right()*0.5*c_move
		ang.y = ang.y + math.sin(ct*8.4)*1.2*p
		ang.p = ang.p + math.sin(ct*16.8)*0.8*p
		ang.r = ang.r + math.cos(ct*8.4)*0.3*p
	end
	
	return pos,ang
end

function SWEP:Sway(pos,ang,ft,iftp)
	local owner = self:GetOwner()
	if !owner:IsValid() then return end

	local sway = 1.2
	if sway == 0 then return pos,ang end
    local angdelta = owner:EyeAngles() - c_oang
	
	if angdelta.y >= 180 then
		angdelta.y = angdelta.y - 360
	elseif angdelta.y <= -180 then
		angdelta.y = angdelta.y + 360
	end
	angdelta.p = math.Clamp(angdelta.p, -5, 5)
	angdelta.y = math.Clamp(angdelta.y, -5, 5)
	angdelta.r = math.Clamp(angdelta.r, -5, 5)
	if iftp then
		local newang = LerpAngle( math.Clamp(ft * 10, 0, 1), c_dang, angdelta )
		c_dang = newang
	end
    c_oang = owner:EyeAngles()
	local psway = sway / (self.SwayPosition or 2)
	ang:RotateAroundAxis( ang:Right(), -c_dang.p*sway )
	ang:RotateAroundAxis( ang:Up(), c_dang.y*sway )
	ang:RotateAroundAxis( ang:Forward(), c_dang.y*sway )
	pos = pos + ang:Right()*c_dang.y*psway + ang:Up()*c_dang.p*psway
    return pos,ang
end

local v_run = 0
function SWEP:CalcView(ply,pos,ang,fov)
	if LocalPlayer():ShouldDrawLocalPlayer() then return end
	local ft,ct = FrameTime(),CurTime()
	v_run = Lerp(ft * 5, v_run,self:GetNWBool('QTG_Running') and self.Owner:OnGround() and 10 or 0)
	return pos,ang,fov+v_run
end

weapons.Register(SWEP, 'qtg_admin_gun')

return SWEP